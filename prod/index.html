<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Op√©rations - Gestion de Patrimoine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fbfbfa 0%, #f7f6f3 100%);
            min-height: 100vh;
            color: #37352f;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(55, 53, 47, 0.08);
            min-width: 400px;
            border: 1px solid #e9e9e7;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #37352f;
            font-size: 28px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #37352f;
            font-size: 14px;
        }

        select, input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e9e9e7;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #fff;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #2383e2;
            box-shadow: 0 0 0 2px rgba(35, 131, 226, 0.1);
        }

        .btn {
            padding: 12px 20px;
            background: #2383e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            background: #1a6fc7;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #2ecc71;
        }

        .hidden {
            display: none;
        }

        .header {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(55, 53, 47, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9e9e7;
        }

        .header h1 {
            color: #37352f;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-badge {
            background: #37352f;
            color: white;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .back-office-badge {
            background: #16a085;
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 6px;
            font-weight: 500;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(55, 53, 47, 0.06);
            border: 1px solid #e9e9e7;
        }

        .tabs {
            display: flex;
            margin-bottom: 32px;
            border-bottom: 1px solid #e9e9e7;
            gap: 4px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            color: #6b7280;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
            background: transparent;
        }

        .tab:hover {
            background: #f7f6f3;
            color: #37352f;
        }

        .tab.active {
            border-bottom-color: #2383e2;
            color: #2383e2;
            background: #f7f6f3;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .operations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(55, 53, 47, 0.06);
            border: 1px solid #e9e9e7;
        }

        .operations-table th,
        .operations-table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f7f6f3;
        }

        .operations-table th {
            background: #37352f;
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .operations-table tbody tr {
            transition: all 0.2s ease;
        }

        .operations-table tbody tr:hover {
            background: #f7f6f3;
        }

        .operations-table tbody tr:nth-child(even) {
            background: #fbfbfa;
        }

        .operations-table tbody tr:nth-child(even):hover {
            background: #f7f6f3;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-envoye { 
            background: #f39c12; 
            color: white; 
        }
        .status-valide { 
            background: #27ae60; 
            color: white; 
        }
        .status-annule { 
            background: #e74c3c; 
            color: white; 
        }
        .status-encours { 
            background: #3498db; 
            color: white; 
        }

        .ca-highlight {
            font-weight: 600;
            color: #27ae60;
            font-size: 15px;
        }

        .readonly {
            background-color: #f7f6f3 !important;
            cursor: not-allowed;
            color: #6b7280;
            border-color: #e9e9e7 !important;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f7f6f3;
            border-radius: 8px;
            border: 1px solid #e9e9e7;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #37352f;
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(55, 53, 47, 0.12);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .stat-card div:last-child {
            font-size: 13px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f7f6f3;
            border-radius: 8px;
            border: 1px solid #e9e9e7;
            transition: all 0.2s ease;
        }

        .checkbox-group:hover {
            border-color: #2383e2;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #37352f;
            font-weight: 500;
        }

        .form-row h3 {
            color: #37352f;
            font-size: 16px;
            font-weight: 600;
            margin: 28px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9e9e7;
        }

        .form-row h3:first-child {
            margin-top: 0;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-start;
        }

        .save-status {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .save-indicator {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .save-indicator.saved {
            background: #d4edda;
            color: #155724;
        }

        .save-indicator.unsaved {
            background: #f8d7da;
            color: #721c24;
        }

        .save-indicator.saving {
            background: #fff3cd;
            color: #856404;
        }

        .last-save-info {
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
        }

        .save-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #37352f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            color: #37352f;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .admin-section {
            background: #f7f6f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #e9e9e7;
        }

        .admin-section h3 {
            color: #37352f;
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9e9e7;
        }

        .admin-section small {
            display: block;
            margin-top: 6px;
            color: #6b7280;
            font-size: 12px;
        }

        .status-info {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e9e9e7;
        }

        .status-info p {
            margin: 8px 0;
            font-size: 14px;
        }

        .status-info strong {
            color: #37352f;
        }

        .admin-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 600;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9e9e7;
            border-radius: 8px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f7f6f3;
            transition: background 0.2s ease;
        }

        .user-item:hover {
            background: #f7f6f3;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            color: #37352f;
        }

        .user-id {
            font-size: 12px;
            color: #6b7280;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .admin-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .admin-only-message {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            font-size: 18px;
            background: #f7f6f3;
            border-radius: 8px;
            border: 1px solid #e9e9e7;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .operations-table {
                font-size: 12px;
            }

            .modal {
                width: 95%;
                padding: 20px;
            }

            .user-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>üèõÔ∏è Connexion</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="userType">Type d'utilisateur</label>
                    <select id="userType" required>
                        <option value="">S√©lectionner...</option>
                        <option value="cgp">CGP</option>
                        <option value="backoffice">Back Office</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                
                <div class="form-group" id="cgpSelectGroup" style="display: none;">
                    <label for="cgpSelect">Conseiller</label>
                    <select id="cgpSelect">
                        <option value="">S√©lectionner...</option>
                    </select>
                </div>
                
                <div class="form-group" id="passwordGroup" style="display: none;">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" placeholder="Entrez votre mot de passe">
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- Page principale -->
    <div id="mainPage" class="hidden">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <h1 id="appTitle">üìä Suivi des Op√©rations</h1>
                    <span id="userBadge" class="user-badge"></span>
                </div>
                <div class="save-status" id="saveStatus">
                    <span id="saveIndicator" class="save-indicator unsaved">
                        üî¥ <span id="unsavedCount">0</span> op√©ration(s) non sauvegard√©e(s)
                    </span>
                    <button id="manualSaveBtn" class="btn btn-small">üíæ Sauvegarder maintenant</button>
                    <button id="loadFromExcelBtn" class="btn btn-small btn-secondary">üì• Charger Excel</button>
                    <span id="lastSaveInfo" class="last-save-info"></span>
                </div>
                <button id="logoutBtn" class="btn btn-secondary btn-small">D√©connexion</button>
            </div>

            <div class="main-content">
                <div class="tabs">
                    <div class="tab active" data-tab="operations" id="operationsTabBtn">üìã Op√©rations</div>
                    <div class="tab" data-tab="nouvelle" id="nouvelleTabBtn">‚ûï Nouvelle Op√©ration</div>
                    <div class="tab" data-tab="admin" id="adminTabBtn" style="display: none;">‚öôÔ∏è Administration</div>
                </div>

                <!-- Message pour admin sans acc√®s aux op√©rations -->
                <div id="adminOnlyMessage" class="admin-only-message hidden">
                    <h3>üîß Mode Administrateur</h3>
                    <p>En tant qu'administrateur, vous avez uniquement acc√®s aux fonctions de configuration.</p>
                    <p>Les op√©rations sont g√©r√©es par les conseillers et le back office.</p>
                </div>

                <!-- Onglet Op√©rations -->
                <div id="operationsTab" class="tab-content">
                    <div class="stats-row" id="statsRow">
                        <div class="stat-card">
                            <div class="stat-value" id="totalOperations">0</div>
                            <div>Op√©rations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalCA">0‚Ç¨</div>
                            <div>CA Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="operationsEnCours">0</div>
                            <div>En cours</div>
                        </div>
                    </div>

                    <div class="filters">
                        <div class="filter-item">
                            <label>Conseiller</label>
                            <select id="filterCGP">
                                <option value="">Tous</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>√âtat</label>
                            <select id="filterEtat">
                                <option value="">Tous</option>
                                <option value="Envoy√© compagnie">Envoy√© compagnie</option>
                                <option value="En cours">En cours</option>
                                <option value="Valid√©">Valid√©</option>
                                <option value="Annul√©">Annul√©</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Domaine</label>
                            <select id="filterDomaine">
                                <option value="">Tous</option>
                                <option value="AV">Assurance Vie</option>
                                <option value="Retraite">Retraite</option>
                                <option value="Produits Structur√©s">Produits Structur√©s</option>
                            </select>
                        </div>
                    </div>

                    <table class="operations-table" id="operationsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Conseiller</th>
                                <th>Domaine</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>CA</th>
                                <th>√âtat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Onglet Nouvelle Op√©ration -->
                <div id="nouvelleTab" class="tab-content hidden">
                    <form id="operationForm">
                        <h3>üë§ Informations Client</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nomClient">Nom et Pr√©nom du client *</label>
                                <input type="text" id="nomClient" required>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="nouveauClient">
                                    <label for="nouveauClient">Nouveau client</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="conseiller">Conseiller *</label>
                                <select id="conseiller" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="assistantBO">Assistant Back Office</label>
                                <select id="assistantBO">
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                        </div>

                        <h3>üíº Informations Produit</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="domaine">Domaine *</label>
                                <select id="domaine" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="AV">Assurance Vie</option>
                                    <option value="Retraite">Retraite</option>
                                    <option value="Produits Structur√©s">Produits Structur√©s</option>
                                    <option value="√âpargne">√âpargne</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fournisseur">Fournisseur *</label>
                                <select id="fournisseur" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Cardif">Cardif</option>
                                    <option value="Generali">Generali</option>
                                    <option value="AXA">AXA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nomContrat">Nom du contrat</label>
                                <select id="nomContrat">
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="referenceContrat">R√©f√©rence du contrat</label>
                                <input type="text" id="referenceContrat">
                            </div>
                        </div>

                        <h3>üí∞ Op√©ration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="typeActe">Type d'acte *</label>
                                <select id="typeActe" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Versement">Versement</option>
                                    <option value="Rachat partiel">Rachat partiel</option>
                                    <option value="Rachat total">Rachat total</option>
                                    <option value="Arbitrage">Arbitrage</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="montant">Montant (‚Ç¨) *</label>
                                <input type="number" id="montant" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="pourcentageFrais">Pourcentage de frais (%)</label>
                                <input type="number" id="pourcentageFrais" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="partieIncomprise">Partie incompressible (‚Ç¨)</label>
                                <input type="number" id="partieIncomprise" step="0.01" min="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="caCalcule">CA Calcul√© (‚Ç¨)</label>
                                <input type="number" id="caCalcule" readonly class="readonly">
                            </div>
                            <div class="form-group">
                                <label for="apporteurAffaire">Apporteur d'affaire</label>
                                <select id="apporteurAffaire">
                                    <option value="">Aucun</option>
                                    <option value="Conseiller">Conseiller</option>
                                    <option value="Direction">Direction</option>
                                    <option value="Progressia">Progressia</option>
                                </select>
                            </div>
                        </div>

                        <h3 id="suiviBackOfficeTitle">üìã Suivi Back Office</h3>
                        <div class="form-row" id="suiviBackOfficeSection">
                            <div class="form-group">
                                <label for="dateEnvoiCompagnie">Date envoi compagnie</label>
                                <input type="date" id="dateEnvoiCompagnie">
                            </div>
                            <div class="form-group">
                                <label for="dateRelance">Date de relance</label>
                                <input type="date" id="dateRelance">
                            </div>
                            <div class="form-group">
                                <label for="dateValidation">Date de validation</label>
                                <input type="date" id="dateValidation">
                            </div>
                            <div class="form-group">
                                <label for="etatGlobal">√âtat global</label>
                                <select id="etatGlobal">
                                    <option value="Envoy√© compagnie">Envoy√© compagnie</option>
                                    <option value="En cours">En cours</option>
                                    <option value="Valid√©">Valid√©</option>
                                    <option value="Annul√©">Annul√©</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn" style="width: 100%; margin-top: 24px;">Enregistrer op√©ration</button>
                    </form>
                </div>

                <!-- Onglet Administration -->
                <div id="adminTab" class="tab-content hidden">
                    <h2>‚öôÔ∏è Administration du Syst√®me</h2>
                    
                    <div class="admin-warning">
                        <strong>‚ö†Ô∏è Zone Administrateur :</strong> Les modifications effectu√©es ici affectent tous les utilisateurs du syst√®me.
                    </div>
                    
                    <div class="admin-section">
                        <h3>üë• Gestion des Conseillers CGP</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="addCGPBtn" class="btn btn-success">‚ûï Ajouter un conseiller</button>
                                <button id="importCGPBtn" class="btn btn-secondary">üì• Importer conseillers</button>
                                <button id="exportCGPBtn" class="btn btn-secondary">üì§ Exporter conseillers</button>
                            </div>
                        </div>
                        <div class="user-list" id="cgpList">
                            <!-- Liste des CGP sera g√©n√©r√©e dynamiquement -->
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üè¢ Gestion du Back Office</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="addBOBtn" class="btn btn-success">‚ûï Ajouter assistant BO</button>
                            </div>
                        </div>
                        <div class="user-list" id="backOfficeList">
                            <!-- Liste du Back Office sera g√©n√©r√©e dynamiquement -->
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üîê Gestion des Administrateurs</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="addAdminBtn" class="btn btn-success">‚ûï Ajouter administrateur</button>
                            </div>
                        </div>
                        <div class="user-list" id="adminList">
                            <!-- Liste des admins sera g√©n√©r√©e dynamiquement -->
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üìù Configuration des Listes</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="manageFournisseursBtn" class="btn btn-secondary">üè≠ G√©rer les fournisseurs</button>
                                <button id="manageDomainesBtn" class="btn btn-secondary">üìä G√©rer les domaines</button>
                            </div>
                            <div class="form-group">
                                <button id="manageContratsBtn" class="btn btn-secondary">üìã G√©rer les contrats</button>
                                <button id="manageTypesActesBtn" class="btn btn-secondary">‚ö° G√©rer les types d'actes</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üìä Connexion Google Sheets</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <div id="googleSheetsConnectionStatus" class="status-info">
                                    <p><strong>Statut :</strong> <span id="connectionStatus">‚ùå Non connect√©</span></p>
                                    <p><strong>Fichier ma√Ætre :</strong> <span id="masterFileStatus">‚ùå Non trouv√©</span></p>
                                    <p><strong>Derni√®re sync :</strong> <span id="lastGoogleSync">Jamais</span></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <button id="connectGoogleSheetsBtn" class="btn btn-success">üîó Se connecter √† Google Sheets</button>
                                <button id="disconnectGoogleSheetsBtn" class="btn btn-secondary" style="display: none;">üîå Se d√©connecter</button>
                                <button id="refreshGoogleSheetsBtn" class="btn btn-secondary" style="display: none;">üîÑ Actualiser</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üìã Configuration Google Sheets</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="masterSheetNameInput">Nom du fichier ma√Ætre</label>
                                <input type="text" id="masterSheetNameInput" value="Gestion Patrimoine - Donn√©es Ma√Ætre">
                                <small>Le fichier sera cr√©√© dans votre Google Drive</small>
                            </div>
                            <div class="form-group">
                                <button id="createGoogleSheetsBtn" class="btn" style="display: none;">üìä Cr√©er nouveau Google Sheet</button>
                                <button id="syncNowBtn" class="btn btn-secondary" style="display: none;">üîÑ Synchroniser maintenant</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üèóÔ∏è Gestion du Fichier Ma√Ætre</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="createMasterFileBtn" class="btn">üìä Cr√©er fichier ma√Ætre Excel</button>
                                <small>
                                    Cr√©e le fichier Excel initial dans Google Drive (√† faire une seule fois)
                                </small>
                            </div>
                            <div class="form-group">
                                <button id="backupMasterFileBtn" class="btn btn-secondary">üíæ Sauvegarder fichier ma√Ætre</button>
                                <small>
                                    Cr√©e une copie de sauvegarde du fichier ma√Ætre
                                </small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="resetMasterFileBtn" class="btn btn-danger">üîÑ R√©initialiser fichier ma√Ætre</button>
                                <small style="color: #e74c3c;">
                                    ‚ö†Ô∏è Attention : Efface toutes les donn√©es existantes !
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üîß Maintenance et Logs</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <button id="exportConfigBtn" class="btn btn-secondary">üì§ Exporter configuration compl√®te</button>
                                <button id="importConfigBtn" class="btn btn-secondary">üì• Importer configuration</button>
                            </div>
                            <div class="form-group">
                                <button id="clearLocalDataBtn" class="btn btn-secondary">üóëÔ∏è Vider les donn√©es locales</button>
                                <button id="exportLogsBtn" class="btn btn-secondary">üìã Exporter les logs</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>üìä Statut du Syst√®me</h3>
                        <div id="systemStatus" class="status-info">
                            <p><strong>Google Sheets :</strong> <span id="googleSheetsStatus">‚ùå Non configur√©</span></p>
                            <p><strong>Derni√®re synchronisation :</strong> <span id="lastSyncStatus">Jamais</span></p>
                            <p><strong>Conseillers actifs :</strong> <span id="activeCGPCount">0</span></p>
                            <p><strong>Assistants BO :</strong> <span id="activeBOCount">0</span></p>
                            <p><strong>Total op√©rations dans le syst√®me :</strong> <span id="totalOpsAdmin">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // ============= CONFIGURATION GOOGLE SHEETS =============
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyCE-HrqYnboe8_UI2c3x9fpGRvaxNg_kRs', // √Ä remplacer par votre cl√© API
            clientId: '270084021063-rivtk4i2qee3odjjqbtkbbe7vn4n0scq.apps.googleusercontent.com', // √Ä remplacer par votre Client ID Google
            discoveryDoc: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
            scopes: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file'
        };

        // Variables pour Google Sheets
        let googleSheetsConnected = false;
        let masterSpreadsheetId = null;
        let masterSpreadsheetName = 'Gestion Patrimoine - Donn√©es Ma√Ætre';
        let gapiLoaded = false;
        let gisLoaded = false;

        // Configuration des utilisateurs avec mots de passe
        let USERS_CONFIG = JSON.parse(localStorage.getItem('usersConfig')) || {
            cgp: [
                { id: 'manon', nom: 'Manon', password: 'Manon4827', backOfficeAutorise: false },
                { id: 'audrey', nom: 'Audrey', password: 'Audrey7314', backOfficeAutorise: false },
                { id: 'baptistef', nom: 'Baptiste F', password: 'BaptisteF1346', backOfficeAutorise: false },
                { id: 'baptistee', nom: 'Baptiste E', password: 'BaptisteE9205', backOfficeAutorise: true },
                { id: 'clement', nom: 'Cl√©ment', password: 'Cl√©ment5862', backOfficeAutorise: false },
                { id: 'nicolas', nom: 'Nicolas', password: 'Nicolas7431', backOfficeAutorise: true },
                { id: 'leo', nom: 'L√©o', password: 'L√©o2198', backOfficeAutorise: false },
                { id: 'maxime', nom: 'Maxime', password: 'Maxime3072', backOfficeAutorise: false },
                { id: 'cyril', nom: 'Cyril', password: 'Cyril6849', backOfficeAutorise: true },
                { id: 'florent', nom: 'Florent', password: 'Florent1956', backOfficeAutorise: false },
                { id: 'polepro', nom: 'P√¥le Pro', password: 'P√¥lePro8641', backOfficeAutorise: true }
            ],
            backOffice: [
                { id: 'bo1', nom: 'Alice Robert', password: 'BackOffice2024!' },
                { id: 'bo2', nom: 'Thomas Bernard', password: 'Admin2024!' }
            ],
            admin: [
                { id: 'admin1', nom: 'Administrateur Syst√®me', password: 'AdminGestion2024!' }
            ]
        };

        // Configuration des r√©f√©rentiels
        let REFERENTIELS_CONFIG = JSON.parse(localStorage.getItem('referentielsConfig')) || {
            fournisseurs: ['Cardif', 'Generali', 'AXA'],
            domaines: ['AV', 'Retraite', 'Produits Structur√©s', '√âpargne'],
            typesActes: ['Versement', 'Rachat partiel', 'Rachat total', 'Arbitrage'],
            apporteurs: ['Conseiller', 'Direction', 'Progressia'],
            contrats: {
                'Cardif': ['Cardif Libert√©', 'Cardif Retraite Plus', 'Cardif Patrimoine'],
                'Generali': ['Generali Patrimoine', 'Generali Retraite', 'Generali Privil√®ge'],
                'AXA': ['AXA Placement', 'AXA Retraite Entreprise', 'AXA S√©lection']
            }
        };

        // Variables globales
        let currentUser = null;
        let operations = JSON.parse(localStorage.getItem('operations') || '[]');
        let lastSaveTime = localStorage.getItem('lastSaveTime') || null;
        let unsavedChanges = false;
        let autoSaveInterval = null;

        // ============= FONCTIONS GOOGLE SHEETS =============

        async function initializeGoogleAPI() {
            console.log('üîÑ Initialisation Google API...');
            
            try {
                // V√©rifier si les cl√©s sont configur√©es
                if (GOOGLE_CONFIG.apiKey === 'YOUR_GOOGLE_API_KEY') {
                    console.log('‚ö†Ô∏è Google API non configur√© - mode local uniquement');
                    updateGoogleSheetsStatus();
                    return;
                }
                
                // V√©rifier si gapi est disponible
                if (typeof gapi === 'undefined') {
                    console.error('‚ùå Google API script non charg√©');
                    return;
                }
                
                console.log('‚úÖ Google API script charg√©');
                
                // Charger l'API client
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                console.log('‚úÖ GAPI Client charg√©');
                
                // Initialiser le client
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    discoveryDocs: [GOOGLE_CONFIG.discoveryDoc],
                });
                
                console.log('‚úÖ GAPI Client initialis√©');
                
                // Charger l'API auth2
                await new Promise((resolve, reject) => {
                    gapi.load('auth2', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                console.log('‚úÖ GAPI Auth2 charg√©');
                
                // Initialiser auth2
                await gapi.auth2.init({
                    client_id: GOOGLE_CONFIG.clientId,
                });
                
                console.log('‚úÖ GAPI Auth2 initialis√©');
                gapiLoaded = true;
                
                // V√©rifier si d√©j√† connect√©
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    console.log('‚úÖ D√©j√† connect√© √† Google');
                    googleSheetsConnected = true;
                    await findOrCreateMasterSheet();
                }
                
                updateGoogleSheetsStatus();
                
            } catch (error) {
                console.error('‚ùå Erreur initialisation Google API:', error);
                updateGoogleSheetsStatus();
            }
        }

        async function connectToGoogleSheets() {
            console.log('üîÑ Tentative de connexion √† Google Sheets...');
            
            try {
                // V√©rifications pr√©liminaires
                if (GOOGLE_CONFIG.apiKey === 'YOUR_GOOGLE_API_KEY') {
                    alert('‚ùå Google Sheets non configur√©.\n\nVeuillez :\n1. Obtenir une cl√© API Google\n2. Obtenir un Client ID\n3. Les remplacer dans le code');
                    return;
                }
                
                if (!gapiLoaded) {
                    alert('‚ùå Google API pas encore charg√©.\n\nAttendez quelques secondes et r√©essayez.');
                    return;
                }
                
                if (typeof gapi === 'undefined' || !gapi.auth2) {
                    console.error('‚ùå GAPI ou Auth2 non disponible');
                    alert('‚ùå Erreur : Google API non disponible');
                    return;
                }
                
                showSavePopup('üîÑ Connexion √† Google Sheets en cours...');
                console.log('üîÑ Demande d\'autorisation utilisateur...');
                
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance) {
                    throw new Error('Instance auth2 non disponible');
                }
                
                // Demander l'autorisation avec les scopes n√©cessaires
                const user = await authInstance.signIn({
                    scope: GOOGLE_CONFIG.scopes
                });
                
                console.log('‚úÖ Utilisateur connect√©:', user.getBasicProfile().getEmail());
                
                if (user.isSignedIn()) {
                    googleSheetsConnected = true;
                    console.log('‚úÖ Connexion r√©ussie');
                    
                    await findOrCreateMasterSheet();
                    updateGoogleSheetsStatus();
                    showSavePopup('‚úÖ Connect√© √† Google Sheets avec succ√®s !');
                } else {
                    throw new Error('√âchec de la connexion utilisateur');
                }
                
            } catch (error) {
                console.error('‚ùå Erreur connexion Google Sheets:', error);
                
                let errorMessage = 'Erreur de connexion : ';
                if (error.error === 'popup_closed_by_user') {
                    errorMessage += 'Popup ferm√© par l\'utilisateur';
                } else if (error.error === 'access_denied') {
                    errorMessage += 'Acc√®s refus√© par l\'utilisateur';
                } else {
                    errorMessage += error.message || 'Erreur inconnue';
                }
                
                alert(errorMessage);
                googleSheetsConnected = false;
                updateGoogleSheetsStatus();
            }
        }

        async function disconnectFromGoogleSheets() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                googleSheetsConnected = false;
                masterSpreadsheetId = null;
                updateGoogleSheetsStatus();
                showSavePopup('D√©connect√© de Google Sheets');
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
            }
        }

        async function findOrCreateMasterSheet() {
            try {
                // Charger l'API Drive
                await gapi.client.load('drive', 'v3');
                
                // Chercher le fichier existant
                const response = await gapi.client.drive.files.list({
                    q: `name='${masterSpreadsheetName}' and mimeType='application/vnd.google-apps.spreadsheet'`,
                    spaces: 'drive'
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    // Fichier trouv√©
                    masterSpreadsheetId = response.result.files[0].id;
                    await loadDataFromGoogleSheets();
                    document.getElementById('masterFileStatus').innerHTML = '‚úÖ Trouv√© et charg√©';
                } else {
                    // Fichier non trouv√©
                    document.getElementById('masterFileStatus').innerHTML = '‚ùå Fichier non trouv√©';
                    masterSpreadsheetId = null;
                }
                
                document.getElementById('lastGoogleSync').textContent = new Date().toLocaleString('fr-FR');
            } catch (error) {
                console.error('Erreur gestion fichier ma√Ætre:', error);
                document.getElementById('masterFileStatus').innerHTML = '‚ùå Erreur';
            }
        }

        async function createMasterGoogleSheet() {
            try {
                if (!googleSheetsConnected) {
                    alert('Vous devez d\'abord vous connecter √† Google Sheets');
                    return;
                }

                masterSpreadsheetName = document.getElementById('masterSheetNameInput').value || 'Gestion Patrimoine - Donn√©es Ma√Ætre';
                
                // Cr√©er le spreadsheet
                const response = await gapi.client.sheets.spreadsheets.create({
                    properties: {
                        title: masterSpreadsheetName
                    },
                    sheets: [
                        { properties: { title: 'Operations' } },
                        { properties: { title: 'Conseillers' } },
                        { properties: { title: 'BackOffice' } },
                        { properties: { title: 'Referentiels' } },
                        { properties: { title: 'Metadata' } }
                    ]
                });
                
                masterSpreadsheetId = response.result.spreadsheetId;
                
                // Initialiser avec les headers
                await initializeSheetHeaders();
                await syncWithGoogleSheets();
                
                document.getElementById('masterFileStatus').innerHTML = '‚úÖ Cr√©√© avec succ√®s';
                showSavePopup('‚úÖ Nouveau Google Sheet cr√©√© !');
                updateGoogleSheetsStatus();
            } catch (error) {
                console.error('Erreur cr√©ation Google Sheet:', error);
                alert('Erreur lors de la cr√©ation : ' + error.message);
            }
        }

        async function initializeSheetHeaders() {
            const requests = [
                // Headers pour Operations
                {
                    updateCells: {
                        range: { sheetId: 0, startRowIndex: 0, endRowIndex: 1 },
                        rows: [{
                            values: [
                                { userEnteredValue: { stringValue: 'ID' } },
                                { userEnteredValue: { stringValue: 'Client' } },
                                { userEnteredValue: { stringValue: 'Nouveau_Client' } },
                                { userEnteredValue: { stringValue: 'Conseiller_ID' } },
                                { userEnteredValue: { stringValue: 'Conseiller_Nom' } },
                                { userEnteredValue: { stringValue: 'Assistant_BO_ID' } },
                                { userEnteredValue: { stringValue: 'Assistant_BO_Nom' } },
                                { userEnteredValue: { stringValue: 'Domaine' } },
                                { userEnteredValue: { stringValue: 'Fournisseur' } },
                                { userEnteredValue: { stringValue: 'Nom_Contrat' } },
                                { userEnteredValue: { stringValue: 'Reference_Contrat' } },
                                { userEnteredValue: { stringValue: 'Type_Acte' } },
                                { userEnteredValue: { stringValue: 'Montant' } },
                                { userEnteredValue: { stringValue: 'Pourcentage_Frais' } },
                                { userEnteredValue: { stringValue: 'Partie_Incompressible' } },
                                { userEnteredValue: { stringValue: 'CA_Calcule' } },
                                { userEnteredValue: { stringValue: 'Apporteur_Affaire' } },
                                { userEnteredValue: { stringValue: 'Date_Envoi_Compagnie' } },
                                { userEnteredValue: { stringValue: 'Date_Relance' } },
                                { userEnteredValue: { stringValue: 'Date_Validation' } },
                                { userEnteredValue: { stringValue: 'Etat_Global' } },
                                { userEnteredValue: { stringValue: 'Date_Creation' } }
                            ]
                        }],
                        fields: 'userEnteredValue'
                    }
                }
            ];
            
            await gapi.client.sheets.spreadsheets.batchUpdate({
                spreadsheetId: masterSpreadsheetId,
                resource: { requests: requests }
            });
        }

        async function loadDataFromGoogleSheets() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: masterSpreadsheetId,
                    range: 'Operations!A1:Z1000'
                });
                
                const values = response.result.values;
                if (!values || values.length < 2) {
                    return; // Pas de donn√©es
                }
                
                const headers = values[0];
                const rows = values.slice(1);
                
                const loadedOperations = rows.map(row => {
                    const operation = {};
                    headers.forEach((header, index) => {
                        operation[header] = row[index] || '';
                    });
                    
                    return {
                        id: operation.ID || Date.now() + Math.random(),
                        nomClient: operation.Client || '',
                        nouveauClient: operation.Nouveau_Client === 'OUI',
                        conseiller: operation.Conseiller_ID || '',
                        conseillerNom: operation.Conseiller_Nom || '',
                        assistantBO: operation.Assistant_BO_ID || '',
                        assistantBONom: operation.Assistant_BO_Nom || '',
                        domaine: operation.Domaine || '',
                        fournisseur: operation.Fournisseur || '',
                        nomContrat: operation.Nom_Contrat || '',
                        referenceContrat: operation.Reference_Contrat || '',
                        typeActe: operation.Type_Acte || '',
                        montant: parseFloat(operation.Montant) || 0,
                        pourcentageFrais: parseFloat(operation.Pourcentage_Frais) || 0,
                        partieIncomprise: parseFloat(operation.Partie_Incompressible) || 0,
                        ca: parseFloat(operation.CA_Calcule) || 0,
                        apporteurAffaire: operation.Apporteur_Affaire || '',
                        dateEnvoiCompagnie: operation.Date_Envoi_Compagnie || '',
                        dateRelance: operation.Date_Relance || '',
                        dateValidation: operation.Date_Validation || '',
                        etatGlobal: operation.Etat_Global || 'En cours',
                        dateCreation: operation.Date_Creation || new Date().toISOString().split('T')[0]
                    };
                });
                
                operations = loadedOperations;
                localStorage.setItem('operations', JSON.stringify(operations));
                
                if (currentUser && currentUser.type !== 'admin') {
                    displayOperations();
                    updateStats();
                }
            } catch (error) {
                console.error('Erreur chargement Google Sheets:', error);
            }
        }

        async function syncWithGoogleSheets() {
            try {
                if (!masterSpreadsheetId) {
                    await findOrCreateMasterSheet();
                    if (!masterSpreadsheetId) {
                        alert('Aucun Google Sheet trouv√©. Cr√©ez-en un d\'abord.');
                        return;
                    }
                }
                
                // Pr√©parer les donn√©es pour Google Sheets
                const sheetData = [
                    ['ID', 'Client', 'Nouveau_Client', 'Conseiller_ID', 'Conseiller_Nom', 'Assistant_BO_ID', 'Assistant_BO_Nom', 'Domaine', 'Fournisseur', 'Nom_Contrat', 'Reference_Contrat', 'Type_Acte', 'Montant', 'Pourcentage_Frais', 'Partie_Incompressible', 'CA_Calcule', 'Apporteur_Affaire', 'Date_Envoi_Compagnie', 'Date_Relance', 'Date_Validation', 'Etat_Global', 'Date_Creation']
                ];
                
                operations.forEach(op => {
                    sheetData.push([
                        op.id,
                        op.nomClient,
                        op.nouveauClient ? 'OUI' : 'NON',
                        op.conseiller,
                        op.conseillerNom,
                        op.assistantBO,
                        op.assistantBONom,
                        op.domaine,
                        op.fournisseur,
                        op.nomContrat,
                        op.referenceContrat,
                        op.typeActe,
                        op.montant,
                        op.pourcentageFrais,
                        op.partieIncomprise,
                        op.ca,
                        op.apporteurAffaire,
                        op.dateEnvoiCompagnie,
                        op.dateRelance,
                        op.dateValidation,
                        op.etatGlobal,
                        op.dateCreation
                    ]);
                });
                
                // Effacer et r√©√©crire la feuille
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: masterSpreadsheetId,
                    range: 'Operations!A:Z'
                });
                
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: masterSpreadsheetId,
                    range: 'Operations!A1',
                    valueInputOption: 'RAW',
                    resource: { values: sheetData }
                });
                
                document.getElementById('lastGoogleSync').textContent = new Date().toLocaleString('fr-FR');
                markSaved();
                showSavePopup('‚úÖ Synchronis√© avec Google Sheets !');
            } catch (error) {
                console.error('Erreur synchronisation:', error);
                alert('Erreur lors de la synchronisation : ' + error.message);
            }
        }

        function updateGoogleSheetsStatus() {
            const connectionStatus = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectGoogleSheetsBtn');
            const disconnectBtn = document.getElementById('disconnectGoogleSheetsBtn');
            const refreshBtn = document.getElementById('refreshGoogleSheetsBtn');
            const createBtn = document.getElementById('createGoogleSheetsBtn');
            const syncBtn = document.getElementById('syncNowBtn');
            
            // V√©rifier la configuration
            const isConfigured = GOOGLE_CONFIG.apiKey !== 'YOUR_GOOGLE_API_KEY' && 
                                GOOGLE_CONFIG.clientId !== 'YOUR_GOOGLE_CLIENT_ID';
            
            if (!isConfigured) {
                connectionStatus.innerHTML = '‚öôÔ∏è Non configur√©';
                if (connectBtn) {
                    connectBtn.textContent = '‚öôÔ∏è Configuration requise';
                    connectBtn.style.display = 'inline-flex';
                    connectBtn.disabled = true;
                }
                if (disconnectBtn) disconnectBtn.style.display = 'none';
                if (refreshBtn) refreshBtn.style.display = 'none';
                if (createBtn) createBtn.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'none';
                return;
            }
            
            if (!gapiLoaded) {
                connectionStatus.innerHTML = 'üîÑ Chargement...';
                if (connectBtn) {
                    connectBtn.textContent = 'üîÑ Chargement...';
                    connectBtn.disabled = true;
                }
                return;
            }
            
            if (googleSheetsConnected) {
                connectionStatus.innerHTML = '‚úÖ Connect√©';
                if (connectBtn) connectBtn.style.display = 'none';
                if (disconnectBtn) disconnectBtn.style.display = 'inline-flex';
                if (refreshBtn) refreshBtn.style.display = 'inline-flex';
                if (createBtn) createBtn.style.display = 'inline-flex';
                if (syncBtn) syncBtn.style.display = 'inline-flex';
            } else {
                connectionStatus.innerHTML = '‚ùå Non connect√©';
                if (connectBtn) {
                    connectBtn.textContent = 'üîó Se connecter √† Google Sheets';
                    connectBtn.disabled = false;
                    connectBtn.style.display = 'inline-flex';
                }
                if (disconnectBtn) disconnectBtn.style.display = 'none';
                if (refreshBtn) refreshBtn.style.display = 'none';
                if (createBtn) createBtn.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'none';
            }
            
            // Mettre √† jour le statut syst√®me
            const googleSheetsStatus = document.getElementById('googleSheetsStatus');
            if (googleSheetsStatus) {
                googleSheetsStatus.innerHTML = 
                    isConfigured ? 
                        (googleSheetsConnected ? 'üü¢ Connect√© via API' : 'üü° Configur√© mais non connect√©') : 
                        '‚ùå Non configur√©';
            }
            
            const lastSync = document.getElementById('lastGoogleSync')?.textContent || 'Jamais';
            const lastSyncStatus = document.getElementById('lastSyncStatus');
            if (lastSyncStatus) {
                lastSyncStatus.textContent = lastSync;
            }
        }

        // Fonction de test de configuration
        function testGoogleConfiguration() {
            console.log('üîç Test de configuration Google...');
            
            // Test 1: V√©rifier les cl√©s
            if (GOOGLE_CONFIG.apiKey === 'YOUR_GOOGLE_API_KEY') {
                console.log('‚ùå API Key non configur√©e');
                return false;
            }
            
            if (GOOGLE_CONFIG.clientId === 'YOUR_GOOGLE_CLIENT_ID') {
                console.log('‚ùå Client ID non configur√©');
                return false;
            }
            
            console.log('‚úÖ Cl√©s API configur√©es');
            
            // Test 2: V√©rifier si gapi est charg√©
            if (typeof gapi === 'undefined') {
                console.log('‚ùå Google API script non charg√©');
                return false;
            }
            
            console.log('‚úÖ Google API script disponible');
            
            // Test 3: V√©rifier l'√©tat de l'initialisation
            if (!gapiLoaded) {
                console.log('‚ö†Ô∏è Google API pas encore initialis√©');
                return false;
            }
            
            console.log('‚úÖ Google API initialis√©');
            return true;
        }

        // Fonction de debug (accessible globalement)
        window.debugGoogleSheets = function() {
            console.log('=== DEBUG GOOGLE SHEETS ===');
            console.log('API Key configur√©e:', GOOGLE_CONFIG.apiKey !== 'YOUR_GOOGLE_API_KEY');
            console.log('Client ID configur√©:', GOOGLE_CONFIG.clientId !== 'YOUR_GOOGLE_CLIENT_ID');
            console.log('GAPI disponible:', typeof gapi !== 'undefined');
            console.log('GAPI charg√©:', gapiLoaded);
            console.log('Google Sheets connect√©:', googleSheetsConnected);
            console.log('Spreadsheet ID:', masterSpreadsheetId);
            
            if (typeof gapi !== 'undefined' && gapi.auth2) {
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance) {
                    console.log('Auth instance disponible:', true);
                    console.log('Utilisateur connect√©:', authInstance.isSignedIn.get());
                } else {
                    console.log('Auth instance disponible:', false);
                }
            }
            
            // Test de connectivit√©
            console.log('Test de connectivit√© Google...');
            fetch('https://apis.google.com/js/api.js')
                .then(() => console.log('‚úÖ APIs Google accessibles'))
                .catch(() => console.log('‚ùå APIs Google inaccessibles'));
        };

        // Version simplifi√©e d'initialisation Google API
        async function initializeGoogleAPI() {
            console.log('üîÑ Initialisation Google API...');
            
            try {
                // V√©rifier si les cl√©s sont configur√©es
                if (GOOGLE_CONFIG.apiKey === 'YOUR_GOOGLE_API_KEY') {
                    console.log('‚ö†Ô∏è Google API non configur√© - mode local uniquement');
                    gapiLoaded = false;
                    updateGoogleSheetsStatus();
                    return;
                }
                
                // V√©rifier si gapi est disponible avec timeout
                let gapiReady = false;
                let attempts = 0;
                const maxAttempts = 10;
                
                while (!gapiReady && attempts < maxAttempts) {
                    if (typeof gapi !== 'undefined') {
                        gapiReady = true;
                        break;
                    }
                    attempts++;
                    console.log(`Tentative ${attempts}/${maxAttempts} de chargement GAPI...`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                if (!gapiReady) {
                    console.error('‚ùå Google API script non accessible apr√®s 5 secondes');
                    gapiLoaded = false;
                    updateGoogleSheetsStatus();
                    return;
                }
                
                console.log('‚úÖ Google API script d√©tect√©');
                
                // Initialisation simple avec timeout
                const initPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout initialisation Google API'));
                    }, 10000); // 10 secondes max
                    
                    gapi.load('client:auth2', {
                        callback: () => {
                            clearTimeout(timeout);
                            resolve();
                        },
                        onerror: () => {
                            clearTimeout(timeout);
                            reject(new Error('Erreur chargement modules GAPI'));
                        }
                    });
                });
                
                await initPromise;
                console.log('‚úÖ Modules GAPI charg√©s');
                
                // Initialisation client avec timeout
                await Promise.race([
                    gapi.client.init({
                        apiKey: GOOGLE_CONFIG.apiKey,
                        clientId: GOOGLE_CONFIG.clientId,
                        discoveryDocs: [GOOGLE_CONFIG.discoveryDoc],
                        scope: GOOGLE_CONFIG.scopes
                    }),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout init client')), 10000)
                    )
                ]);
                
                console.log('‚úÖ Client Google initialis√©');
                gapiLoaded = true;
                
                // V√©rifier si d√©j√† connect√©
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    console.log('‚úÖ D√©j√† connect√© √† Google');
                    googleSheetsConnected = true;
                    await findOrCreateMasterSheet();
                }
                
                updateGoogleSheetsStatus();
                
            } catch (error) {
                console.error('‚ùå Erreur initialisation Google API:', error);
                gapiLoaded = false;
                updateGoogleSheetsStatus();
                
                // Proposer le mode local
                setTimeout(() => {
                    if (!gapiLoaded) {
                        console.log('üí° Mode local disponible (sauvegarde Excel)');
                        showSavePopup('‚ö†Ô∏è Google Sheets indisponible - Mode local activ√©');
                    }
                }, 2000);
            }
        }

        // ============= INITIALISATION =============
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            populateSelects();
            setupEventListeners();
            loadSampleData();
            updateSaveStatus();
            startAutoSave();
            initializeGoogleAPI();
        }

        function populateSelects() {
            // Peuple les s√©lecteurs de CGP
            const cgpSelects = ['cgpSelect', 'conseiller', 'filterCGP'];
            cgpSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">S√©lectionner...</option>';
                    USERS_CONFIG.cgp.forEach(cgp => {
                        const option = document.createElement('option');
                        option.value = cgp.id;
                        option.textContent = cgp.nom;
                        select.appendChild(option);
                    });
                }
            });

            // Peuple les assistants back office
            const assistantSelect = document.getElementById('assistantBO');
            if (assistantSelect) {
                assistantSelect.innerHTML = '<option value="">S√©lectionner...</option>';
                USERS_CONFIG.backOffice.forEach(bo => {
                    const option = document.createElement('option');
                    option.value = bo.id;
                    option.textContent = bo.nom;
                    assistantSelect.appendChild(option);
                });
            }

            populateReferentiels();
        }

        function populateReferentiels() {
            // Fournisseurs
            const fournisseurSelect = document.getElementById('fournisseur');
            if (fournisseurSelect) {
                fournisseurSelect.innerHTML = '<option value="">S√©lectionner...</option>';
                REFERENTIELS_CONFIG.fournisseurs.forEach(fournisseur => {
                    const option = document.createElement('option');
                    option.value = fournisseur;
                    option.textContent = fournisseur;
                    fournisseurSelect.appendChild(option);
                });
            }

            // Domaines
            const domaineSelects = ['domaine', 'filterDomaine'];
            domaineSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = selectId === 'filterDomaine' ? '<option value="">Tous</option>' : '<option value="">S√©lectionner...</option>';
                    REFERENTIELS_CONFIG.domaines.forEach(domaine => {
                        const option = document.createElement('option');
                        option.value = domaine;
                        option.textContent = domaine === 'AV' ? 'Assurance Vie' : domaine;
                        select.appendChild(option);
                    });
                    if (currentValue) select.value = currentValue;
                }
            });

            // Types d'actes
            const typeActeSelect = document.getElementById('typeActe');
            if (typeActeSelect) {
                typeActeSelect.innerHTML = '<option value="">S√©lectionner...</option>';
                REFERENTIELS_CONFIG.typesActes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeActeSelect.appendChild(option);
                });
            }

            // Apporteurs
            const apporteurSelect = document.getElementById('apporteurAffaire');
            if (apporteurSelect) {
                apporteurSelect.innerHTML = '<option value="">Aucun</option>';
                REFERENTIELS_CONFIG.apporteurs.forEach(apporteur => {
                    const option = document.createElement('option');
                    option.value = apporteur;
                    option.textContent = apporteur;
                    apporteurSelect.appendChild(option);
                });
            }
        }

        function setupEventListeners() {
            // Connexion
            document.getElementById('userType').addEventListener('change', handleUserTypeChange);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Formulaire op√©ration
            const operationForm = document.getElementById('operationForm');
            if (operationForm) {
                operationForm.addEventListener('submit', handleOperationSubmit);
            }

            document.getElementById('fournisseur').addEventListener('change', updateContratsList);
            
            // Calcul automatique du CA
            ['montant', 'pourcentageFrais', 'partieIncomprise'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateCA);
                }
            });

            // Filtres
            ['filterCGP', 'filterEtat', 'filterDomaine'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                }
            });

            // Syst√®me de sauvegarde
            document.getElementById('manualSaveBtn').addEventListener('click', saveToExcel);
            document.getElementById('loadFromExcelBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            // Input file cach√© pour l'import Excel
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.id = 'fileInput';
            fileInput.accept = '.xlsx,.xls';
            fileInput.addEventListener('change', loadFromExcel);
            document.body.appendChild(fileInput);

            // √âv√©nements admin
            setupAdminEventListeners();
        }

        function setupAdminEventListeners() {
            // Gestion des utilisateurs
            const addCGPBtn = document.getElementById('addCGPBtn');
            if (addCGPBtn) {
                addCGPBtn.addEventListener('click', () => showAddUserModal('cgp'));
                document.getElementById('addBOBtn').addEventListener('click', () => showAddUserModal('backoffice'));
                document.getElementById('addAdminBtn').addEventListener('click', () => showAddUserModal('admin'));

                // Gestion des listes
                document.getElementById('manageFournisseursBtn').addEventListener('click', () => showManageListModal('fournisseurs'));
                document.getElementById('manageDomainesBtn').addEventListener('click', () => showManageListModal('domaines'));
                document.getElementById('manageContratsBtn').addEventListener('click', () => showManageListModal('contrats'));
                document.getElementById('manageTypesActesBtn').addEventListener('click', () => showManageListModal('typesActes'));

                // Google Sheets - Version avec fallback
                const connectBtn = document.getElementById('connectGoogleSheetsBtn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Clic sur connexion Google Sheets');
                        
                        // Si pas encore charg√©, r√©essayer l'initialisation
                        if (!gapiLoaded) {
                            showSavePopup('üîÑ R√©initialisation Google API...');
                            initializeGoogleAPI().then(() => {
                                if (gapiLoaded) {
                                    connectToGoogleSheets();
                                } else {
                                    alert('‚ùå Google API inaccessible.\n\nL\'application fonctionne en mode local avec sauvegarde Excel.');
                                }
                            });
                            return;
                        }
                        
                        // Test rapide avant connexion
                        if (!testGoogleConfiguration()) {
                            alert('‚ùå Configuration Google incompl√®te.\n\nPour activer Google Sheets :\n1. Obtenez une cl√© API Google\n2. Obtenez un Client ID\n3. Remplacez-les dans le code\n\nEn attendant, l\'app fonctionne en mode local.');
                            return;
                        }
                        
                        connectToGoogleSheets();
                    });
                }
                
                const disconnectBtn = document.getElementById('disconnectGoogleSheetsBtn');
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', disconnectFromGoogleSheets);
                }
                
                const refreshBtn = document.getElementById('refreshGoogleSheetsBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        findOrCreateMasterSheet();
                        showSavePopup('Connexion Google Sheets actualis√©e');
                    });
                }
                
                const createBtn = document.getElementById('createGoogleSheetsBtn');
                if (createBtn) {
                    createBtn.addEventListener('click', createMasterGoogleSheet);
                }
                
                const syncBtn = document.getElementById('syncNowBtn');
                if (syncBtn) {
                    syncBtn.addEventListener('click', syncWithGoogleSheets);
                }

                // Anciens √©v√©nements
                document.getElementById('createMasterFileBtn').addEventListener('click', createMasterFile);
                document.getElementById('backupMasterFileBtn').addEventListener('click', backupMasterFile);
                document.getElementById('resetMasterFileBtn').addEventListener('click', resetMasterFile);

                // Import/Export
                document.getElementById('exportCGPBtn').addEventListener('click', () => exportUsers('cgp'));
                document.getElementById('importCGPBtn').addEventListener('click', () => importUsers('cgp'));
                document.getElementById('exportConfigBtn').addEventListener('click', exportConfig);
                document.getElementById('importConfigBtn').addEventListener('click', importConfig);
                document.getElementById('clearLocalDataBtn').addEventListener('click', clearLocalData);
                document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);
            }
        }

        // ============= FONCTIONS DE CONNEXION =============

        function handleUserTypeChange(e) {
            const cgpGroup = document.getElementById('cgpSelectGroup');
            const passwordGroup = document.getElementById('passwordGroup');
            
            if (e.target.value === 'cgp') {
                cgpGroup.style.display = 'block';
                passwordGroup.style.display = 'block';
                document.getElementById('cgpSelect').required = true;
                document.getElementById('password').required = true;
                document.getElementById('password').placeholder = 'Mot de passe CGP';
            } else if (e.target.value === 'backoffice') {
                cgpGroup.style.display = 'none';
                passwordGroup.style.display = 'block';
                document.getElementById('cgpSelect').required = false;
                document.getElementById('password').required = true;
                document.getElementById('password').placeholder = 'Mot de passe Back Office';
            } else if (e.target.value === 'admin') {
                cgpGroup.style.display = 'none';
                passwordGroup.style.display = 'block';
                document.getElementById('cgpSelect').required = false;
                document.getElementById('password').required = true;
                document.getElementById('password').placeholder = 'Mot de passe Administrateur';
            } else {
                cgpGroup.style.display = 'none';
                passwordGroup.style.display = 'none';
                document.getElementById('cgpSelect').required = false;
                document.getElementById('password').required = false;
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const userType = document.getElementById('userType').value;
            const cgpId = document.getElementById('cgpSelect').value;
            const password = document.getElementById('password').value;

            if (userType === 'cgp') {
                if (!cgpId) {
                    alert('Veuillez s√©lectionner un conseiller');
                    return;
                }
                
                const selectedCGP = USERS_CONFIG.cgp.find(cgp => cgp.id === cgpId);
                if (!selectedCGP) {
                    alert('Conseiller non trouv√©');
                    return;
                }
                
                if (selectedCGP.password !== password) {
                    alert('Mot de passe incorrect');
                    return;
                }
                
                currentUser = {
                    type: 'cgp',
                    ...selectedCGP
                };
            } else if (userType === 'backoffice') {
                const backOfficeUser = USERS_CONFIG.backOffice.find(bo => bo.password === password);
                if (!backOfficeUser) {
                    alert('Mot de passe Back Office incorrect');
                    return;
                }
                
                currentUser = {
                    type: 'backoffice',
                    ...backOfficeUser,
                    backOfficeAutorise: true
                };
            } else if (userType === 'admin') {
                const adminUser = USERS_CONFIG.admin.find(admin => admin.password === password);
                if (!adminUser) {
                    alert('Mot de passe Administrateur incorrect');
                    return;
                }
                
                currentUser = {
                    type: 'admin',
                    ...adminUser,
                    backOfficeAutorise: true
                };
            } else {
                alert('Veuillez s√©lectionner un type d\'utilisateur');
                return;
            }

            showMainPage();
            if (currentUser.type !== 'admin') {
                startAutoSave();
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('cgpSelectGroup').style.display = 'none';
            document.getElementById('passwordGroup').style.display = 'none';
            stopAutoSave();
        }

        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            updateUserInterface();
            if (currentUser.type !== 'admin') {
                displayOperations();
                updateStats();
            }
        }

        function updateUserInterface() {
            const userBadge = document.getElementById('userBadge');
            const adminTab = document.getElementById('adminTabBtn');
            const operationsTab = document.getElementById('operationsTabBtn');
            const nouvelleTab = document.getElementById('nouvelleTabBtn');
            const saveStatus = document.getElementById('saveStatus');
            const appTitle = document.getElementById('appTitle');
            const adminOnlyMessage = document.getElementById('adminOnlyMessage');
            
            let badgeText = currentUser.nom;
            
            if (currentUser.type === 'cgp') {
                badgeText += ' (CGP)';
                if (currentUser.backOfficeAutorise) {
                    badgeText += ' <span class="back-office-badge">BO Autoris√©</span>';
                }
                adminTab.style.display = 'none';
                operationsTab.style.display = 'block';
                nouvelleTab.style.display = 'block';
                saveStatus.style.display = 'flex';
                adminOnlyMessage.classList.add('hidden');
                appTitle.textContent = 'üìä Suivi des Op√©rations';
            } else if (currentUser.type === 'backoffice') {
                badgeText += ' (Back Office)';
                adminTab.style.display = 'none';
                operationsTab.style.display = 'block';
                nouvelleTab.style.display = 'block';
                saveStatus.style.display = 'flex';
                adminOnlyMessage.classList.add('hidden');
                appTitle.textContent = 'üìä Suivi des Op√©rations';
            } else if (currentUser.type === 'admin') {
                badgeText += ' <span class="admin-badge">ADMIN</span>';
                adminTab.style.display = 'block';
                operationsTab.style.display = 'none';
                nouvelleTab.style.display = 'none';
                saveStatus.style.display = 'none';
                adminOnlyMessage.classList.remove('hidden');
                appTitle.textContent = '‚öôÔ∏è Administration Syst√®me';
                
                // Basculer directement vers l'onglet admin
                switchTab('admin');
                loadAdminInterface();
            }
            
            userBadge.innerHTML = badgeText;

            // Gestion des droits d'acc√®s au formulaire
            const suiviSection = document.getElementById('suiviBackOfficeSection');
            const suiviTitle = document.getElementById('suiviBackOfficeTitle');
            
            if (currentUser.type === 'cgp' && !currentUser.backOfficeAutorise) {
                // CGP sans autorisation : section back office en lecture seule
                suiviSection.querySelectorAll('input, select').forEach(field => {
                    field.classList.add('readonly');
                    field.disabled = true;
                });
                suiviTitle.innerHTML = 'üìã Suivi Back Office <span style="color: #6c757d; font-size: 12px;">(Lecture seule)</span>';
            }

            // Pr√©-s√©lection du conseiller si CGP connect√©
            if (currentUser.type === 'cgp') {
                const conseillerSelect = document.getElementById('conseiller');
                if (conseillerSelect) {
                    conseillerSelect.value = currentUser.id;
                    conseillerSelect.disabled = true;
                }
            }
        }

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (activeTab && activeTab.style.display !== 'none') {
                activeTab.classList.add('active');
            }

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.remove('hidden');
            }

            // Show/hide admin message
            if (currentUser && currentUser.type === 'admin' && (tabName === 'operations' || tabName === 'nouvelle')) {
                document.getElementById('adminOnlyMessage').classList.remove('hidden');
            } else {
                document.getElementById('adminOnlyMessage').classList.add('hidden');
            }

            if (tabName === 'operations' && currentUser.type !== 'admin') {
                displayOperations();
                updateStats();
            }
        }

        // ============= FONCTIONS OP√âRATIONS =============

        function updateContratsList() {
            const fournisseur = document.getElementById('fournisseur').value;
            const contratSelect = document.getElementById('nomContrat');
            
            contratSelect.innerHTML = '<option value="">S√©lectionner...</option>';
            
            if (fournisseur && REFERENTIELS_CONFIG.contrats[fournisseur]) {
                REFERENTIELS_CONFIG.contrats[fournisseur].forEach(contrat => {
                    const option = document.createElement('option');
                    option.value = contrat;
                    option.textContent = contrat;
                    contratSelect.appendChild(option);
                });
            }
        }

        function calculateCA() {
            const montant = parseFloat(document.getElementById('montant').value) || 0;
            const pourcentage = parseFloat(document.getElementById('pourcentageFrais').value) || 0;
            const incomprise = parseFloat(document.getElementById('partieIncomprise').value) || 0;
            
            const ca = (montant * pourcentage / 100) - incomprise;
            document.getElementById('caCalcule').value = Math.max(0, ca).toFixed(2);
        }

        function handleOperationSubmit(e) {
            e.preventDefault();
            
            const form = e.target;
            const editingId = form.dataset.editingId;
            
            const operationData = {
                nomClient: document.getElementById('nomClient').value,
                nouveauClient: document.getElementById('nouveauClient').checked,
                conseiller: document.getElementById('conseiller').value,
                conseillerNom: USERS_CONFIG.cgp.find(cgp => cgp.id === document.getElementById('conseiller').value)?.nom || '',
                assistantBO: document.getElementById('assistantBO').value,
                assistantBONom: USERS_CONFIG.backOffice.find(bo => bo.id === document.getElementById('assistantBO').value)?.nom || '',
                domaine: document.getElementById('domaine').value,
                fournisseur: document.getElementById('fournisseur').value,
                nomContrat: document.getElementById('nomContrat').value,
                referenceContrat: document.getElementById('referenceContrat').value,
                typeActe: document.getElementById('typeActe').value,
                montant: parseFloat(document.getElementById('montant').value),
                pourcentageFrais: parseFloat(document.getElementById('pourcentageFrais').value) || 0,
                partieIncomprise: parseFloat(document.getElementById('partieIncomprise').value) || 0,
                ca: parseFloat(document.getElementById('caCalcule').value) || 0,
                apporteurAffaire: document.getElementById('apporteurAffaire').value,
                dateEnvoiCompagnie: document.getElementById('dateEnvoiCompagnie').value,
                dateRelance: document.getElementById('dateRelance').value,
                dateValidation: document.getElementById('dateValidation').value,
                etatGlobal: document.getElementById('etatGlobal').value
            };

            if (editingId) {
                const index = operations.findIndex(op => op.id == editingId);
                if (index !== -1) {
                    operations[index] = { ...operations[index], ...operationData };
                    alert('Op√©ration mise √† jour avec succ√®s !');
                }
                delete form.dataset.editingId;
                form.querySelector('button[type="submit"]').textContent = 'Enregistrer op√©ration';
            } else {
                const operation = {
                    id: Date.now(),
                    ...operationData,
                    dateCreation: new Date().toISOString().split('T')[0]
                };
                operations.push(operation);
                alert('Op√©ration enregistr√©e avec succ√®s !');
            }

            localStorage.setItem('operations', JSON.stringify(operations));
            form.reset();
            document.getElementById('caCalcule').value = '';
            
            if (currentUser && currentUser.type === 'cgp') {
                document.getElementById('conseiller').value = currentUser.id;
            }
            
            switchTab('operations');
            markUnsavedChanges();
        }

        function displayOperations() {
            const tbody = document.getElementById('operationsTableBody');
            let filteredOperations = operations;

            // Filtrer selon l'utilisateur connect√©
            if (currentUser.type === 'cgp') {
                filteredOperations = operations.filter(op => op.conseiller === currentUser.id);
            }

            // Appliquer les filtres
            filteredOperations = applyCurrentFilters(filteredOperations);

            tbody.innerHTML = '';
            filteredOperations.forEach(operation => {
                const row = createOperationRow(operation);
                tbody.appendChild(row);
            });
        }

        function createOperationRow(operation) {
            const row = document.createElement('tr');
            
            const statusClass = {
                'Envoy√© compagnie': 'status-envoye',
                'En cours': 'status-encours',
                'Valid√©': 'status-valide',
                'Annul√©': 'status-annule'
            }[operation.etatGlobal] || 'status-encours';

            row.innerHTML = `
                <td>${operation.nomClient} ${operation.nouveauClient ? '<span style="color: #28a745;">‚óè</span>' : ''}</td>
                <td>${operation.conseillerNom}</td>
                <td>${operation.domaine}</td>
                <td>${operation.typeActe}</td>
                <td>${operation.montant?.toLocaleString('fr-FR')} ‚Ç¨</td>
                <td class="ca-highlight">${operation.ca?.toLocaleString('fr-FR')} ‚Ç¨</td>
                <td><span class="status-badge ${statusClass}">${operation.etatGlobal}</span></td>
                <td class="actions-cell">
                    <button onclick="editOperation(${operation.id})" class="btn btn-small">Modifier</button>
                    <button onclick="deleteOperation(${operation.id})" class="btn btn-small btn-danger">Supprimer</button>
                </td>
            `;
            return row;
        }

        function applyCurrentFilters(operations) {
            const filterCGP = document.getElementById('filterCGP').value;
            const filterEtat = document.getElementById('filterEtat').value;
            const filterDomaine = document.getElementById('filterDomaine').value;

            return operations.filter(operation => {
                return (!filterCGP || operation.conseiller === filterCGP) &&
                       (!filterEtat || operation.etatGlobal === filterEtat) &&
                       (!filterDomaine || operation.domaine === filterDomaine);
            });
        }

        function applyFilters() {
            displayOperations();
            updateStats();
        }

        function updateStats() {
            let filteredOperations = operations;

            // Filtrer selon l'utilisateur connect√©
            if (currentUser.type === 'cgp') {
                filteredOperations = operations.filter(op => op.conseiller === currentUser.id);
            }

            // Appliquer les filtres actuels
            filteredOperations = applyCurrentFilters(filteredOperations);

            const totalOperations = filteredOperations.length;
            const totalCA = filteredOperations.reduce((sum, op) => sum + (op.ca || 0), 0);
            const operationsEnCours = filteredOperations.filter(op => 
                op.etatGlobal === 'En cours' || op.etatGlobal === 'Envoy√© compagnie'
            ).length;

            document.getElementById('totalOperations').textContent = totalOperations;
            document.getElementById('totalCA').textContent = totalCA.toLocaleString('fr-FR') + '‚Ç¨';
            document.getElementById('operationsEnCours').textContent = operationsEnCours;
        }

        function editOperation(id) {
            const operation = operations.find(op => op.id === id);
            if (!operation) return;

            // V√©rifier les droits d'√©dition
            if (currentUser.type === 'cgp' && operation.conseiller !== currentUser.id) {
                alert('Vous ne pouvez modifier que vos propres op√©rations.');
                return;
            }

            // Remplir le formulaire avec les donn√©es existantes
            document.getElementById('nomClient').value = operation.nomClient || '';
            document.getElementById('nouveauClient').checked = operation.nouveauClient || false;
            document.getElementById('conseiller').value = operation.conseiller || '';
            document.getElementById('assistantBO').value = operation.assistantBO || '';
            document.getElementById('domaine').value = operation.domaine || '';
            document.getElementById('fournisseur').value = operation.fournisseur || '';
            
            // Update contrats list based on fournisseur
            updateContratsList();
            document.getElementById('nomContrat').value = operation.nomContrat || '';
            
            document.getElementById('referenceContrat').value = operation.referenceContrat || '';
            document.getElementById('typeActe').value = operation.typeActe || '';
            document.getElementById('montant').value = operation.montant || '';
            document.getElementById('pourcentageFrais').value = operation.pourcentageFrais || '';
            document.getElementById('partieIncomprise').value = operation.partieIncomprise || '';
            document.getElementById('apporteurAffaire').value = operation.apporteurAffaire || '';
            document.getElementById('dateEnvoiCompagnie').value = operation.dateEnvoiCompagnie || '';
            document.getElementById('dateRelance').value = operation.dateRelance || '';
            document.getElementById('dateValidation').value = operation.dateValidation || '';
            document.getElementById('etatGlobal').value = operation.etatGlobal || 'En cours';

            // Recalculer le CA
            calculateCA();

            // Changer le comportement du formulaire pour la modification
            const form = document.getElementById('operationForm');
            form.dataset.editingId = id;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Mettre √† jour op√©ration';

            // Basculer vers l'onglet de saisie
            switchTab('nouvelle');
        }

        function deleteOperation(id) {
            const operation = operations.find(op => op.id === id);
            if (!operation) return;

            // V√©rifier les droits de suppression
            if (currentUser.type === 'cgp' && operation.conseiller !== currentUser.id) {
                alert('Vous ne pouvez supprimer que vos propres op√©rations.');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette op√©ration ?')) {
                operations = operations.filter(op => op.id !== id);
                localStorage.setItem('operations', JSON.stringify(operations));
                displayOperations();
                updateStats();
                markUnsavedChanges();
            }
        }

        function loadSampleData() {
            // Charger des donn√©es d'exemple si aucune donn√©e n'existe
            if (operations.length === 0) {
                const sampleOperations = [
                    {
                        id: 1,
                        nomClient: 'Pierre Martin',
                        nouveauClient: true,
                        conseiller: 'manon',
                        conseillerNom: 'Manon',
                        assistantBO: 'bo1',
                        assistantBONom: 'Alice Robert',
                        domaine: 'AV',
                        fournisseur: 'Cardif',
                        nomContrat: 'Cardif Libert√©',
                        referenceContrat: 'CL123456',
                        typeActe: 'Versement',
                        montant: 50000,
                        pourcentageFrais: 2.5,
                        partieIncomprise: 100,
                        ca: 1150,
                        apporteurAffaire: 'Conseiller',
                        dateEnvoiCompagnie: '2024-12-15',
                        dateRelance: '',
                        dateValidation: '2024-12-20',
                        etatGlobal: 'Valid√©',
                        dateCreation: '2024-12-15'
                    },
                    {
                        id: 2,
                        nomClient: 'Marie Dubois',
                        nouveauClient: false,
                        conseiller: 'audrey',
                        conseillerNom: 'Audrey',
                        assistantBO: 'bo2',
                        assistantBONom: 'Thomas Bernard',
                        domaine: 'Retraite',
                        fournisseur: 'Generali',
                        nomContrat: 'Generali Retraite',
                        referenceContrat: 'GR789012',
                        typeActe: 'Rachat partiel',
                        montant: 25000,
                        pourcentageFrais: 1.8,
                        partieIncomprise: 50,
                        ca: 400,
                        apporteurAffaire: 'Direction',
                        dateEnvoiCompagnie: '2024-12-18',
                        dateRelance: '2024-12-25',
                        dateValidation: '',
                        etatGlobal: 'En cours',
                        dateCreation: '2024-12-18'
                    }
                ];
                
                operations = sampleOperations;
                localStorage.setItem('operations', JSON.stringify(operations));
            }
        }

        // ============= FONCTIONS DE SAUVEGARDE =============

        function markUnsavedChanges() {
            unsavedChanges = true;
            updateSaveStatus();
        }

        function markSaved() {
            unsavedChanges = false;
            lastSaveTime = new Date().toLocaleString('fr-FR');
            localStorage.setItem('lastSaveTime', lastSaveTime);
            updateSaveStatus();
        }

        function updateSaveStatus() {
            const indicator = document.getElementById('saveIndicator');
            const lastSaveInfo = document.getElementById('lastSaveInfo');
            
            if (unsavedChanges) {
                indicator.className = 'save-indicator unsaved';
                indicator.innerHTML = 'üî¥ <span id="unsavedCount">' + getUnsavedCount() + '</span> op√©ration(s) non sauvegard√©e(s)';
            } else {
                indicator.className = 'save-indicator saved';
                indicator.innerHTML = 'üü¢ Toutes les donn√©es sont sauvegard√©es';
            }
            
            if (lastSaveTime) {
                lastSaveInfo.textContent = 'Derni√®re sauvegarde : ' + lastSaveTime;
            }
        }

        function getUnsavedCount() {
            return operations.length;
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (unsavedChanges) {
                    autoSaveToExcel();
                }
            }, 15 * 60 * 1000); // 15 minutes
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        function saveToExcel() {
            if (googleSheetsConnected && masterSpreadsheetId) {
                // Synchronisation automatique avec Google Sheets
                syncWithGoogleSheets();
            } else {
                // Fallback: t√©l√©chargement local
                const indicator = document.getElementById('saveIndicator');
                indicator.className = 'save-indicator saving';
                indicator.innerHTML = 'üü° Sauvegarde en cours...';
                
                const workbook = createExcelWorkbook();
                const fileName = 'operations_patrimoine_' + new Date().toISOString().slice(0,16).replace(/[:]/g, 'h') + '.xlsx';
                
                downloadExcelFile(workbook, fileName);
                
                markSaved();
                showSavePopup('Donn√©es sauvegard√©es vers ' + fileName + ' (Google Sheets non connect√©)');
            }
        }

        function autoSaveToExcel() {
            if (googleSheetsConnected && masterSpreadsheetId) {
                // Auto-sync avec Google Sheets
                const indicator = document.getElementById('saveIndicator');
                indicator.className = 'save-indicator saving';
                indicator.innerHTML = 'üü° Synchronisation automatique...';
                
                syncWithGoogleSheets().then(() => {
                    showSavePopup('üîÑ Synchronisation automatique Google Sheets effectu√©e');
                }).catch(error => {
                    console.error('Erreur auto-sync:', error);
                    // Fallback vers sauvegarde locale
                    setTimeout(() => {
                        markSaved();
                        showSavePopup('Sauvegarde automatique locale effectu√©e');
                    }, 2000);
                });
            } else {
                // Fallback: simulation auto-save local
                const indicator = document.getElementById('saveIndicator');
                indicator.className = 'save-indicator saving';
                indicator.innerHTML = 'üü° Sauvegarde automatique en cours...';
                
                setTimeout(() => {
                    markSaved();
                    showSavePopup('Sauvegarde automatique effectu√©e');
                }, 2000);
            }
        }

        function createExcelWorkbook() {
            const workbook = XLSX.utils.book_new();
            
            // === FEUILLE 1: OPERATIONS ===
            const operationsData = operations.map(op => ({
                'ID': op.id,
                'Client': op.nomClient,
                'Nouveau_Client': op.nouveauClient ? 'OUI' : 'NON',
                'Conseiller_ID': op.conseiller,
                'Conseiller_Nom': op.conseillerNom,
                'Assistant_BO_ID': op.assistantBO,
                'Assistant_BO_Nom': op.assistantBONom,
                'Domaine': op.domaine,
                'Fournisseur': op.fournisseur,
                'Nom_Contrat': op.nomContrat,
                'Reference_Contrat': op.referenceContrat,
                'Type_Acte': op.typeActe,
                'Montant': op.montant,
                'Pourcentage_Frais': op.pourcentageFrais,
                'Partie_Incompressible': op.partieIncomprise,
                'CA_Calcule': op.ca,
                'Apporteur_Affaire': op.apporteurAffaire,
                'Date_Envoi_Compagnie': op.dateEnvoiCompagnie,
                'Date_Relance': op.dateRelance,
                'Date_Validation': op.dateValidation,
                'Etat_Global': op.etatGlobal,
                'Date_Creation': op.dateCreation
            }));
            
            const operationsSheet = XLSX.utils.json_to_sheet(operationsData);
            XLSX.utils.book_append_sheet(workbook, operationsSheet, 'Operations');
            
            // === FEUILLE 2: CONSEILLERS ===
            const conseillersData = USERS_CONFIG.cgp.map(cgp => ({
                'ID': cgp.id,
                'Nom': cgp.nom,
                'Mot_De_Passe': cgp.password,
                'BackOffice_Autorise': cgp.backOfficeAutorise ? 'OUI' : 'NON'
            }));
            
            const conseillersSheet = XLSX.utils.json_to_sheet(conseillersData);
            XLSX.utils.book_append_sheet(workbook, conseillersSheet, 'Conseillers');
            
            // === FEUILLE 3: BACK OFFICE ===
            const backOfficeData = USERS_CONFIG.backOffice.map(bo => ({
                'ID': bo.id,
                'Nom': bo.nom,
                'Mot_De_Passe': bo.password
            }));
            
            const backOfficeSheet = XLSX.utils.json_to_sheet(backOfficeData);
            XLSX.utils.book_append_sheet(workbook, backOfficeSheet, 'BackOffice');
            
            // === FEUILLE 4: REFERENTIELS ===
            const referentielsData = [
                ...REFERENTIELS_CONFIG.fournisseurs.map(f => ({ 'Type': 'Fournisseur', 'Valeur': f })),
                ...REFERENTIELS_CONFIG.domaines.map(d => ({ 'Type': 'Domaine', 'Valeur': d })),
                ...REFERENTIELS_CONFIG.typesActes.map(t => ({ 'Type': 'Type_Acte', 'Valeur': t })),
                ...REFERENTIELS_CONFIG.apporteurs.map(a => ({ 'Type': 'Apporteur', 'Valeur': a })),
                { 'Type': 'Etat', 'Valeur': 'Envoy√© compagnie' },
                { 'Type': 'Etat', 'Valeur': 'En cours' },
                { 'Type': 'Etat', 'Valeur': 'Valid√©' },
                { 'Type': 'Etat', 'Valeur': 'Annul√©' }
            ];
            
            const referentielsSheet = XLSX.utils.json_to_sheet(referentielsData);
            XLSX.utils.book_append_sheet(workbook, referentielsSheet, 'Referentiels');
            
            // === FEUILLE 5: METADATA ===
            const metadataData = [
                { 'Propriete': 'Version', 'Valeur': '1.0' },
                { 'Propriete': 'Date_Sauvegarde', 'Valeur': new Date().toLocaleString('fr-FR') },
                { 'Propriete': 'Utilisateur', 'Valeur': currentUser?.nom || 'System' },
                { 'Propriete': 'Nombre_Operations', 'Valeur': operations.length },
                { 'Propriete': 'Format', 'Valeur': 'Gestion Patrimoine v1.0' }
            ];
            
            const metadataSheet = XLSX.utils.json_to_sheet(metadataData);
            XLSX.utils.book_append_sheet(workbook, metadataSheet, 'Metadata');
            
            return workbook;
        }

        function downloadExcelFile(workbook, fileName) {
            const excelBuffer = XLSX.write(workbook, { 
                bookType: 'xlsx', 
                type: 'array',
                compression: true 
            });
            
            const blob = new Blob([excelBuffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);
        }

        function loadFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    if (!workbook.SheetNames.includes('Operations')) {
                        alert('Le fichier Excel ne contient pas la feuille "Operations"');
                        return;
                    }
                    
                    const operationsSheet = workbook.Sheets['Operations'];
                    const operationsData = XLSX.utils.sheet_to_json(operationsSheet);
                    
                    const loadedOperations = operationsData.map(row => ({
                        id: row.ID || Date.now() + Math.random(),
                        nomClient: row.Client || '',
                        nouveauClient: row.Nouveau_Client === 'OUI',
                        conseiller: row.Conseiller_ID || '',
                        conseillerNom: row.Conseiller_Nom || '',
                        assistantBO: row.Assistant_BO_ID || '',
                        assistantBONom: row.Assistant_BO_Nom || '',
                        domaine: row.Domaine || '',
                        fournisseur: row.Fournisseur || '',
                        nomContrat: row.Nom_Contrat || '',
                        referenceContrat: row.Reference_Contrat || '',
                        typeActe: row.Type_Acte || '',
                        montant: parseFloat(row.Montant) || 0,
                        pourcentageFrais: parseFloat(row.Pourcentage_Frais) || 0,
                        partieIncomprise: parseFloat(row.Partie_Incompressible) || 0,
                        ca: parseFloat(row.CA_Calcule) || 0,
                        apporteurAffaire: row.Apporteur_Affaire || '',
                        dateEnvoiCompagnie: row.Date_Envoi_Compagnie || '',
                        dateRelance: row.Date_Relance || '',
                        dateValidation: row.Date_Validation || '',
                        etatGlobal: row.Etat_Global || 'En cours',
                        dateCreation: row.Date_Creation || new Date().toISOString().split('T')[0]
                    }));
                    
                    operations = loadedOperations;
                    localStorage.setItem('operations', JSON.stringify(operations));
                    
                    displayOperations();
                    updateStats();
                    markSaved();
                    
                    showSavePopup(`${loadedOperations.length} op√©rations charg√©es depuis ${file.name}`);
                    
                } catch (error) {
                    console.error('Erreur lors du chargement:', error);
                    alert('Erreur lors du chargement du fichier Excel : ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        // ============= FONCTIONS D'ADMINISTRATION =============

        function loadAdminInterface() {
            displayUserLists();
            updateAdminStatus();
            updateGoogleSheetsStatus();
        }

        function displayUserLists() {
            displayCGPList();
            displayBackOfficeList();
            displayAdminList();
        }

        function displayCGPList() {
            const container = document.getElementById('cgpList');
            container.innerHTML = '';
            
            USERS_CONFIG.cgp.forEach(cgp => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info-item">
                        <div class="user-name">${cgp.nom} ${cgp.backOfficeAutorise ? '<span class="back-office-badge">BO</span>' : ''}</div>
                        <div class="user-id">ID: ${cgp.id}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-small btn-secondary" onclick="editUser('cgp', '${cgp.id}')">‚úèÔ∏è Modifier</button>
                        <button class="btn btn-small btn-danger" onclick="deleteUser('cgp', '${cgp.id}')">üóëÔ∏è Supprimer</button>
                    </div>
                `;
                container.appendChild(userItem);
            });
        }

        function displayBackOfficeList() {
            const container = document.getElementById('backOfficeList');
            container.innerHTML = '';
            
            USERS_CONFIG.backOffice.forEach(bo => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info-item">
                        <div class="user-name">${bo.nom}</div>
                        <div class="user-id">ID: ${bo.id}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-small btn-secondary" onclick="editUser('backoffice', '${bo.id}')">‚úèÔ∏è Modifier</button>
                        <button class="btn btn-small btn-danger" onclick="deleteUser('backoffice', '${bo.id}')">üóëÔ∏è Supprimer</button>
                    </div>
                `;
                container.appendChild(userItem);
            });
        }

        function displayAdminList() {
            const container = document.getElementById('adminList');
            container.innerHTML = '';
            
            USERS_CONFIG.admin.forEach(admin => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-info-item">
                        <div class="user-name">${admin.nom}</div>
                        <div class="user-id">ID: ${admin.id}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-small btn-secondary" onclick="editUser('admin', '${admin.id}')">‚úèÔ∏è Modifier</button>
                        ${USERS_CONFIG.admin.length > 1 ? `<button class="btn btn-small btn-danger" onclick="deleteUser('admin', '${admin.id}')">üóëÔ∏è Supprimer</button>` : ''}
                    </div>
                `;
                container.appendChild(userItem);
            });
        }

        function showAddUserModal(userType) {
            const modal = createModal('Ajouter un utilisateur');
            const typeLabel = userType === 'cgp' ? 'Conseiller' : userType === 'backoffice' ? 'Assistant Back Office' : 'Administrateur';
            
            modal.querySelector('.modal').innerHTML = `
                <h3>‚ûï Ajouter un ${typeLabel}</h3>
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="userId">ID utilisateur *</label>
                        <input type="text" id="userId" required placeholder="Ex: jdupont">
                    </div>
                    <div class="form-group">
                        <label for="userName">Nom complet *</label>
                        <input type="text" id="userName" required placeholder="Ex: Jean Dupont">
                    </div>
                    <div class="form-group">
                        <label for="userPassword">Mot de passe *</label>
                        <input type="text" id="userPassword" required placeholder="Mot de passe">
                        <button type="button" class="btn btn-small btn-secondary" onclick="generatePassword()" style="margin-top: 8px;">üé≤ G√©n√©rer</button>
                    </div>
                    ${userType === 'cgp' ? `
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="backOfficeAuth">
                            <label for="backOfficeAuth">Autoriser l'acc√®s Back Office</label>
                        </div>
                    </div>
                    ` : ''}
                    <div class="modal-buttons">
                        <button type="submit" class="btn btn-success">‚úÖ Ajouter</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>
                    </div>
                </form>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('addUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                addUser(userType);
            });
        }

        function addUser(userType) {
            const userId = document.getElementById('userId').value.trim();
            const userName = document.getElementById('userName').value.trim();
            const userPassword = document.getElementById('userPassword').value.trim();
            const backOfficeAuth = userType === 'cgp' ? document.getElementById('backOfficeAuth').checked : false;
            
            if (!userId || !userName || !userPassword) {
                alert('Tous les champs sont obligatoires');
                return;
            }
            
            // V√©rifier si l'ID existe d√©j√†
            const allUsers = [...USERS_CONFIG.cgp, ...USERS_CONFIG.backOffice, ...USERS_CONFIG.admin];
            if (allUsers.find(u => u.id === userId)) {
                alert('Cet ID utilisateur existe d√©j√†');
                return;
            }
            
            const newUser = {
                id: userId,
                nom: userName,
                password: userPassword
            };
            
            if (userType === 'cgp') {
                newUser.backOfficeAutorise = backOfficeAuth;
                USERS_CONFIG.cgp.push(newUser);
            } else if (userType === 'backoffice') {
                USERS_CONFIG.backOffice.push(newUser);
            } else {
                USERS_CONFIG.admin.push(newUser);
            }
            
            saveUsersConfig();
            displayUserLists();
            populateSelects();
            updateAdminStatus();
            closeModal();
            showSavePopup(`Utilisateur "${userName}" ajout√© avec succ√®s`);
        }

        function editUser(userType, userId) {
            const userList = userType === 'cgp' ? USERS_CONFIG.cgp : 
                           userType === 'backoffice' ? USERS_CONFIG.backOffice : 
                           USERS_CONFIG.admin;
            
            const user = userList.find(u => u.id === userId);
            if (!user) return;
            
            const modal = createModal('Modifier un utilisateur');
            const typeLabel = userType === 'cgp' ? 'Conseiller' : userType === 'backoffice' ? 'Assistant Back Office' : 'Administrateur';
            
            modal.querySelector('.modal').innerHTML = `
                <h3>‚úèÔ∏è Modifier ${typeLabel}</h3>
                <form id="editUserForm">
                    <div class="form-group">
                        <label for="editUserId">ID utilisateur *</label>
                        <input type="text" id="editUserId" value="${user.id}" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserName">Nom complet *</label>
                        <input type="text" id="editUserName" value="${user.nom}" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserPassword">Mot de passe *</label>
                        <input type="text" id="editUserPassword" value="${user.password}" required>
                        <button type="button" class="btn btn-small btn-secondary" onclick="generatePassword('editUserPassword')" style="margin-top: 8px;">üé≤ G√©n√©rer nouveau</button>
                    </div>
                    ${userType === 'cgp' ? `
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="editBackOfficeAuth" ${user.backOfficeAutorise ? 'checked' : ''}>
                            <label for="editBackOfficeAuth">Autoriser l'acc√®s Back Office</label>
                        </div>
                    </div>
                    ` : ''}
                    <div class="modal-buttons">
                        <button type="submit" class="btn btn-success">üíæ Sauvegarder</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå Annuler</button>
                    </div>
                </form>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('editUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                updateUser(userType, userId);
            });
        }

        function updateUser(userType, originalUserId) {
            const newUserId = document.getElementById('editUserId').value.trim();
            const userName = document.getElementById('editUserName').value.trim();
            const userPassword = document.getElementById('editUserPassword').value.trim();
            const backOfficeAuth = userType === 'cgp' ? document.getElementById('editBackOfficeAuth').checked : false;
            
            if (!newUserId || !userName || !userPassword) {
                alert('Tous les champs sont obligatoires');
                return;
            }
            
            // V√©rifier si le nouvel ID existe d√©j√† (sauf si c'est le m√™me)
            if (newUserId !== originalUserId) {
                const allUsers = [...USERS_CONFIG.cgp, ...USERS_CONFIG.backOffice, ...USERS_CONFIG.admin];
                if (allUsers.find(u => u.id === newUserId)) {
                    alert('Cet ID utilisateur existe d√©j√†');
                    return;
                }
            }
            
            const userList = userType === 'cgp' ? USERS_CONFIG.cgp : 
                           userType === 'backoffice' ? USERS_CONFIG.backOffice : 
                           USERS_CONFIG.admin;
            
            const userIndex = userList.findIndex(u => u.id === originalUserId);
            if (userIndex > -1) {
                userList[userIndex] = {
                    id: newUserId,
                    nom: userName,
                    password: userPassword,
                    ...(userType === 'cgp' && { backOfficeAutorise: backOfficeAuth })
                };
                
                saveUsersConfig();
                displayUserLists();
                populateSelects();
                closeModal();
                showSavePopup(`Utilisateur "${userName}" modifi√© avec succ√®s`);
            }
        }

        function deleteUser(userType, userId) {
            const userList = userType === 'cgp' ? USERS_CONFIG.cgp : 
                           userType === 'backoffice' ? USERS_CONFIG.backOffice : 
                           USERS_CONFIG.admin;
            
            const user = userList.find(u => u.id === userId);
            if (!user) return;
            
            if (userType === 'admin' && USERS_CONFIG.admin.length === 1) {
                alert('Impossible de supprimer le dernier administrateur !');
                return;
            }
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${user.nom}" ?`)) {
                return;
            }
            
            const index = userList.findIndex(u => u.id === userId);
            if (index > -1) {
                userList.splice(index, 1);
                saveUsersConfig();
                displayUserLists();
                populateSelects();
                updateAdminStatus();
                showSavePopup(`Utilisateur "${user.nom}" supprim√©`);
            }
        }

        function generatePassword(inputId = 'userPassword') {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById(inputId).value = password;
        }

        function saveUsersConfig() {
            localStorage.setItem('usersConfig', JSON.stringify(USERS_CONFIG));
        }

        function updateAdminStatus() {
            document.getElementById('activeCGPCount').textContent = USERS_CONFIG.cgp.length;
            document.getElementById('activeBOCount').textContent = USERS_CONFIG.backOffice.length;
            document.getElementById('totalOpsAdmin').textContent = operations.length;
        }

        // Fonctions de gestion des listes et autres fonctions admin similaires √† l'original...
        function showManageListModal(listType) {
            // Implementation similaire √† l'original
            alert('Fonction de gestion des listes √† impl√©menter');
        }

        function createMasterFile() {
            if (!confirm('Cr√©er le fichier ma√Ætre Excel ? Cela √©crasera le fichier existant s\'il y en a un.')) {
                return;
            }
            
            const workbook = createExcelWorkbook();
            const fileName = 'operations_patrimoine_maitre.xlsx';
            
            downloadExcelFile(workbook, fileName);
            showSavePopup('Fichier ma√Ætre cr√©√© ! Copiez-le dans votre dossier configur√©.');
            
            localStorage.setItem('masterFileCreated', 'true');
            updateAdminStatus();
        }

        function backupMasterFile() {
            const workbook = createExcelWorkbook();
            const fileName = 'backup_patrimoine_' + new Date().toISOString().slice(0,16).replace(/[:]/g, 'h') + '.xlsx';
            
            downloadExcelFile(workbook, fileName);
            showSavePopup('Sauvegarde cr√©√©e : ' + fileName);
        }

        function resetMasterFile() {
            if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCette action va :\n- Supprimer toutes les op√©rations du syst√®me\n- Cr√©er un nouveau fichier ma√Ætre vide\n\n√ätes-vous s√ªr ?')) {
                return;
            }
            
            if (!confirm('Derni√®re confirmation : Voulez-vous vraiment TOUT effacer ?')) {
                return;
            }
            
            operations = [];
            localStorage.removeItem('operations');
            localStorage.removeItem('lastSaveTime');
            
            createMasterFile();
            showSavePopup('Syst√®me r√©initialis√© - Nouveau fichier ma√Ætre cr√©√©');
            updateAdminStatus();
        }

        function exportUsers(userType) {
            alert('Fonction d\'export utilisateurs √† impl√©menter');
        }

        function importUsers(userType) {
            alert('Fonction d\'import utilisateurs √† impl√©menter');
        }

        function exportConfig() {
            const config = {
                users: USERS_CONFIG,
                referentiels: REFERENTIELS_CONFIG,
                exportDate: new Date().toLocaleString('fr-FR'),
                version: '1.0'
            };
            
            downloadJSON(config, `config_complete_${new Date().toISOString().slice(0,10)}.json`);
            showSavePopup('Configuration compl√®te export√©e');
        }

        function importConfig() {
            alert('Fonction d\'import configuration √† impl√©menter');
        }

        function clearLocalData() {
            if (!confirm('Supprimer toutes les donn√©es en cache local ?\n\n(La configuration utilisateurs sera conserv√©e)')) {
                return;
            }
            
            localStorage.removeItem('operations');
            localStorage.removeItem('lastSaveTime');
            operations = [];
            
            showSavePopup('Donn√©es locales supprim√©es');
            updateAdminStatus();
        }

        function exportLogs() {
            const logs = {
                systemInfo: {
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString(),
                    currentUser: currentUser?.nom || 'Admin',
                    operationsCount: operations.length,
                    lastSave: lastSaveTime,
                    googleSheetsConfigured: GOOGLE_CONFIG.apiKey !== 'YOUR_GOOGLE_API_KEY',
                    localStorageSize: JSON.stringify(localStorage).length
                },
                userStats: {
                    cgpCount: USERS_CONFIG.cgp.length,
                    backOfficeCount: USERS_CONFIG.backOffice.length,
                    adminCount: USERS_CONFIG.admin.length
                }
            };
            
            downloadJSON(logs, `logs_system_${new Date().toISOString().slice(0,10)}.json`);
            showSavePopup('Logs syst√®me export√©s');
        }

        // ============= FONCTIONS UTILITAIRES =============

        function createModal(title) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `<div class="modal"></div>`;
            return modal;
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        function downloadJSON(data, filename) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showSavePopup(message) {
            const existingPopup = document.querySelector('.save-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            const popup = document.createElement('div');
            popup.className = 'save-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 3000);
        }

        // D√©marrage de l'application
        window.addEventListener('beforeunload', (e) => {
            if (unsavedChanges && currentUser && currentUser.type !== 'admin') {
                e.preventDefault();
                e.returnValue = 'Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>