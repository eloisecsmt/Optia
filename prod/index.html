<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi des Op√©rations - Gestion de Patrimoine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fbfbfa 0%, #f7f6f3 100%);
            min-height: 100vh;
            color: #37352f;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(55, 53, 47, 0.08);
            min-width: 400px;
            border: 1px solid #e9e9e7;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #37352f;
            font-size: 28px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #37352f;
            font-size: 14px;
        }

        select, input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e9e9e7;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #fff;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #2383e2;
            box-shadow: 0 0 0 2px rgba(35, 131, 226, 0.1);
        }

        .btn {
            padding: 12px 20px;
            background: #2383e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            background: #1a6fc7;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #2ecc71;
        }

        .hidden {
            display: none;
        }

        .header {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(55, 53, 47, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9e9e7;
        }

        .header h1 {
            color: #37352f;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-badge {
            background: #37352f;
            color: white;
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .back-office-badge {
            background: #16a085;
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 6px;
            font-weight: 500;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(55, 53, 47, 0.06);
            border: 1px solid #e9e9e7;
        }

        .tabs {
            display: flex;
            margin-bottom: 32px;
            border-bottom: 1px solid #e9e9e7;
            gap: 4px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            color: #6b7280;
            font-weight: 500;
            border-radius: 6px 6px 0 0;
            background: transparent;
        }

        .tab:hover {
            background: #f7f6f3;
            color: #37352f;
        }

        .tab.active {
            border-bottom-color: #2383e2;
            color: #2383e2;
            background: #f7f6f3;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .operations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(55, 53, 47, 0.06);
            border: 1px solid #e9e9e7;
        }

        .operations-table th,
        .operations-table td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #f7f6f3;
        }

        .operations-table th {
            background: #37352f;
            color: white;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .operations-table tbody tr {
            transition: all 0.2s ease;
        }

        .operations-table tbody tr:hover {
            background: #f7f6f3;
        }

        .operations-table tbody tr:nth-child(even) {
            background: #fbfbfa;
        }

        .operations-table tbody tr:nth-child(even):hover {
            background: #f7f6f3;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-envoye { 
            background: #f39c12; 
            color: white; 
        }
        .status-valide { 
            background: #27ae60; 
            color: white; 
        }
        .status-annule { 
            background: #e74c3c; 
            color: white; 
        }
        .status-encours { 
            background: #3498db; 
            color: white; 
        }

        .ca-highlight {
            font-weight: 600;
            color: #27ae60;
            font-size: 15px;
        }

        .readonly {
            background-color: #f7f6f3 !important;
            cursor: not-allowed;
            color: #6b7280;
            border-color: #e9e9e7 !important;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f7f6f3;
            border-radius: 8px;
            border: 1px solid #e9e9e7;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #37352f;
            color: white;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(55, 53, 47, 0.12);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .stat-card div:last-child {
            font-size: 13px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: #f7f6f3;
            border-radius: 8px;
            border: 1px solid #e9e9e7;
            transition: all 0.2s ease;
        }

        .checkbox-group:hover {
            border-color: #2383e2;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #37352f;
            font-weight: 500;
        }

        .form-row h3 {
            color: #37352f;
            font-size: 16px;
            font-weight: 600;
            margin: 28px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9e9e7;
        }

        .form-row h3:first-child {
            margin-top: 0;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-start;
        }

        .save-status {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .save-indicator {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .save-indicator.saved {
            background: #d4edda;
            color: #155724;
        }

        .save-indicator.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .save-indicator.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .last-save-info {
            font-size: 11px;
            color: #6b7280;
            font-style: italic;
        }

        .save-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #37352f;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connection-status.online {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .operations-table {
                font-size: 12px;
            }

            .save-status {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>üèõÔ∏è Connexion</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="userType">Type d'utilisateur</label>
                    <select id="userType" required>
                        <option value="">S√©lectionner...</option>
                        <option value="cgp">CGP</option>
                        <option value="backoffice">Back Office</option>
                        <option value="admin">Administrateur</option>
                    </select>
                </div>
                
                <div class="form-group" id="cgpSelectGroup" style="display: none;">
                    <label for="cgpSelect">Conseiller</label>
                    <select id="cgpSelect">
                        <option value="">S√©lectionner...</option>
                    </select>
                </div>
                
                <div class="form-group" id="passwordGroup" style="display: none;">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" placeholder="Entrez votre mot de passe">
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Se connecter</button>
            </form>
        </div>
    </div>

    <!-- Page principale -->
    <div id="mainPage" class="hidden">
        <div class="container">
            <div class="header">
                <div class="user-info">
                    <h1 id="appTitle">üìä Suivi des Op√©rations</h1>
                    <span id="userBadge" class="user-badge"></span>
                </div>
                <div class="save-status" id="saveStatus">
                    <span id="connectionStatus" class="connection-status online">
                        üü¢ Connect√© au serveur
                    </span>
                    <span id="saveIndicator" class="save-indicator saved">
                        ‚úÖ Donn√©es synchronis√©es
                    </span>
                    <button id="manualSyncBtn" class="btn btn-small">üîÑ Actualiser</button>
                    <span id="lastSyncInfo" class="last-save-info"></span>
                </div>
                <button id="logoutBtn" class="btn btn-secondary btn-small">D√©connexion</button>
            </div>

            <div class="main-content">
                <div class="tabs">
                    <div class="tab active" data-tab="operations" id="operationsTabBtn">üìã Op√©rations</div>
                    <div class="tab" data-tab="nouvelle" id="nouvelleTabBtn">‚ûï Nouvelle Op√©ration</div>
                    <div class="tab" data-tab="admin" id="adminTabBtn" style="display: none;">‚öôÔ∏è Administration</div>
                </div>

                <!-- Onglet Op√©rations -->
                <div id="operationsTab" class="tab-content">
                    <div class="stats-row" id="statsRow">
                        <div class="stat-card">
                            <div class="stat-value" id="totalOperations">0</div>
                            <div>Op√©rations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalCA">0‚Ç¨</div>
                            <div>CA Total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="operationsEnCours">0</div>
                            <div>En cours</div>
                        </div>
                    </div>

                    <div class="filters">
                        <div class="filter-item">
                            <label>Conseiller</label>
                            <select id="filterCGP">
                                <option value="">Tous</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>√âtat</label>
                            <select id="filterEtat">
                                <option value="">Tous</option>
                                <option value="Envoy√© compagnie">Envoy√© compagnie</option>
                                <option value="En cours">En cours</option>
                                <option value="Valid√©">Valid√©</option>
                                <option value="Annul√©">Annul√©</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Domaine</label>
                            <select id="filterDomaine">
                                <option value="">Tous</option>
                                <option value="AV">Assurance Vie</option>
                                <option value="Retraite">Retraite</option>
                                <option value="Produits Structur√©s">Produits Structur√©s</option>
                            </select>
                        </div>
                    </div>

                    <table class="operations-table" id="operationsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Conseiller</th>
                                <th>Domaine</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>CA</th>
                                <th>√âtat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="operationsTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Onglet Nouvelle Op√©ration -->
                <div id="nouvelleTab" class="tab-content hidden">
                    <form id="operationForm">
                        <h3>üë§ Informations Client</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nomClient">Nom et Pr√©nom du client *</label>
                                <input type="text" id="nomClient" required>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="nouveauClient">
                                    <label for="nouveauClient">Nouveau client</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="conseiller">Conseiller *</label>
                                <select id="conseiller" required>
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="assistantBO">Assistant Back Office</label>
                                <select id="assistantBO">
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                        </div>

                        <h3>üíº Informations Produit</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="domaine">Domaine *</label>
                                <select id="domaine" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="AV">Assurance Vie</option>
                                    <option value="Retraite">Retraite</option>
                                    <option value="Produits Structur√©s">Produits Structur√©s</option>
                                    <option value="√âpargne">√âpargne</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fournisseur">Fournisseur *</label>
                                <select id="fournisseur" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Cardif">Cardif</option>
                                    <option value="Generali">Generali</option>
                                    <option value="AXA">AXA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nomContrat">Nom du contrat</label>
                                <select id="nomContrat">
                                    <option value="">S√©lectionner...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="referenceContrat">R√©f√©rence du contrat</label>
                                <input type="text" id="referenceContrat">
                            </div>
                        </div>

                        <h3>üí∞ Op√©ration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="typeActe">Type d'acte *</label>
                                <select id="typeActe" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Versement">Versement</option>
                                    <option value="Rachat partiel">Rachat partiel</option>
                                    <option value="Rachat total">Rachat total</option>
                                    <option value="Arbitrage">Arbitrage</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="montant">Montant (‚Ç¨) *</label>
                                <input type="number" id="montant" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="pourcentageFrais">Pourcentage de frais (%)</label>
                                <input type="number" id="pourcentageFrais" step="0.01" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="partieIncomprise">Partie incompressible (‚Ç¨)</label>
                                <input type="number" id="partieIncomprise" step="0.01" min="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="caCalcule">CA Calcul√© (‚Ç¨)</label>
                                <input type="number" id="caCalcule" readonly class="readonly">
                            </div>
                            <div class="form-group">
                                <label for="apporteurAffaire">Apporteur d'affaire</label>
                                <select id="apporteurAffaire">
                                    <option value="">Aucun</option>
                                    <option value="Conseiller">Conseiller</option>
                                    <option value="Direction">Direction</option>
                                    <option value="Progressia">Progressia</option>
                                </select>
                            </div>
                        </div>

                        <h3 id="suiviBackOfficeTitle">üìã Suivi Back Office</h3>
                        <div class="form-row" id="suiviBackOfficeSection">
                            <div class="form-group">
                                <label for="dateEnvoiCompagnie">Date envoi compagnie</label>
                                <input type="date" id="dateEnvoiCompagnie">
                            </div>
                            <div class="form-group">
                                <label for="dateRelance">Date de relance</label>
                                <input type="date" id="dateRelance">
                            </div>
                            <div class="form-group">
                                <label for="dateValidation">Date de validation</label>
                                <input type="date" id="dateValidation">
                            </div>
                            <div class="form-group">
                                <label for="etatGlobal">√âtat global</label>
                                <select id="etatGlobal">
                                    <option value="Envoy√© compagnie">Envoy√© compagnie</option>
                                    <option value="En cours">En cours</option>
                                    <option value="Valid√©">Valid√©</option>
                                    <option value="Annul√©">Annul√©</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn" style="width: 100%; margin-top: 24px;">Enregistrer op√©ration</button>
                    </form>
                </div>

                <!-- Onglet Administration -->
                <div id="adminTab" class="tab-content hidden">
                    <h2>‚öôÔ∏è Administration du Syst√®me</h2>
                    
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-value" id="totalUsers">0</div>
                            <div>Utilisateurs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalOpsAdmin">0</div>
                            <div>Op√©rations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lastActivityAdmin">-</div>
                            <div>Derni√®re activit√©</div>
                        </div>
                    </div>

                    <div style="background: #f7f6f3; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                        <h3>üåê Statut du Serveur</h3>
                        <p id="serverStatus">‚úÖ Serveur op√©rationnel - Base de donn√©es synchronis√©e</p>
                        <p><strong>URL :</strong> <span id="appUrl">-</span></p>
                        <p><strong>Derni√®re synchronisation :</strong> <span id="lastServerSync">-</span></p>
                    </div>

                    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border: 1px solid #ffeaa7;">
                        <h3>üìã Fonctionnalit√©s Admin</h3>
                        <p>L'interface d'administration compl√®te sera ajout√©e dans une prochaine version.</p>
                        <p>Actuellement disponible : visualisation temps r√©el des donn√©es partag√©es.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= CONFIGURATION API =============
        const API_BASE_URL = window.location.origin; // URL de votre app Vercel
        
        // Variables globales
        let currentUser = null;
        let operations = [];
        let users = [];
        let lastSyncTime = null;
        let isOnline = navigator.onLine;
        let syncInterval = null;

        // ============= FONCTIONS API =============
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Erreur API:', error);
                updateConnectionStatus(false);
                throw error;
            }
        }

        // Authentification
        async function authenticateUser(userType, userId, password) {
            return await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ userType, userId, password })
            });
        }

        // Op√©rations
        async function fetchOperations() {
            return await apiCall('/operations');
        }

        async function createOperation(operationData) {
            return await apiCall('/operations', {
                method: 'POST',
                body: JSON.stringify(operationData)
            });
        }

        async function updateOperation(id, operationData) {
            return await apiCall(`/operations/${id}`, {
                method: 'PUT',
                body: JSON.stringify(operationData)
            });
        }

        async function deleteOperation(id) {
            return await apiCall(`/operations/${id}`, {
                method: 'DELETE'
            });
        }

        // Utilisateurs
        async function fetchUsers() {
            return await apiCall('/users');
        }

        // ============= INITIALISATION =============
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkConnectionStatus();
            startSyncInterval();
        });

        function initializeApp() {
            updateConnectionStatus(isOnline);
            
            // G√©rer les changements de connexion
            window.addEventListener('online', () => {
                updateConnectionStatus(true);
                syncData();
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus(false);
            });
        }

        function setupEventListeners() {
            // Connexion
            document.getElementById('userType').addEventListener('change', handleUserTypeChange);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // Formulaire op√©ration
            document.getElementById('operationForm').addEventListener('submit', handleOperationSubmit);
            document.getElementById('fournisseur').addEventListener('change', updateContratsList);
            
            // Calcul automatique du CA
            ['montant', 'pourcentageFrais', 'partieIncomprise'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateCA);
            });

            // Filtres
            ['filterCGP', 'filterEtat', 'filterDomaine'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });

            // Synchronisation manuelle
            document.getElementById('manualSyncBtn').addEventListener('click', syncData);
        }

        // ============= GESTION CONNEXION =============
        
        function handleUserTypeChange(e) {
            const cgpGroup = document.getElementById('cgpSelectGroup');
            const passwordGroup = document.getElementById('passwordGroup');
            
            if (e.target.value === 'cgp') {
                cgpGroup.style.display = 'block';
                passwordGroup.style.display = 'block';
                loadCGPList();
            } else if (e.target.value === 'backoffice' || e.target.value === 'admin') {
                cgpGroup.style.display = 'none';
                passwordGroup.style.display = 'block';
            } else {
                cgpGroup.style.display = 'none';
                passwordGroup.style.display = 'none';
            }
        }

        async function loadCGPList() {
            try {
                const userData = await fetchUsers();
                const cgpSelect = document.getElementById('cgpSelect');
                cgpSelect.innerHTML = '<option value="">S√©lectionner...</option>';
                
                userData.cgp.forEach(cgp => {
                    const option = document.createElement('option');
                    option.value = cgp.id;
                    option.textContent = cgp.nom;
                    cgpSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erreur chargement CGP:', error);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const userType = document.getElementById('userType').value;
            const cgpId = document.getElementById('cgpSelect').value;
            const password = document.getElementById('password').value;

            try {
                const response = await authenticateUser(userType, cgpId, password);
                
                if (response.success) {
                    currentUser = response.user;
                    showMainPage();
                    await syncData();
                } else {
                    alert('Connexion √©chou√©e : ' + (response.message || 'Identifiants incorrects'));
                }
            } catch (error) {
                alert('Erreur de connexion au serveur. Veuillez r√©essayer.');
                console.error('Erreur login:', error);
            }
        }

        function handleLogout() {
            currentUser = null;
            operations = [];
            users = [];
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('loginForm').reset();
            stopSyncInterval();
        }

        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            updateUserInterface();
            populateSelects();
        }

        function updateUserInterface() {
            const userBadge = document.getElementById('userBadge');
            const adminTab = document.getElementById('adminTabBtn');
            const appTitle = document.getElementById('appTitle');
            
            let badgeText = currentUser.nom;
            
            if (currentUser.type === 'cgp') {
                badgeText += ' (CGP)';
                if (currentUser.backOfficeAutorise) {
                    badgeText += ' <span class="back-office-badge">BO</span>';
                }
                adminTab.style.display = 'none';
                appTitle.textContent = 'üìä Suivi des Op√©rations';
            } else if (currentUser.type === 'backoffice') {
                badgeText += ' (Back Office)';
                adminTab.style.display = 'none';
                appTitle.textContent = 'üìä Suivi des Op√©rations';
            } else if (currentUser.type === 'admin') {
                badgeText += ' <span class="admin-badge">ADMIN</span>';
                adminTab.style.display = 'block';
                appTitle.textContent = '‚öôÔ∏è Administration Syst√®me';
            }
            
            userBadge.innerHTML = badgeText;

            // Gestion des droits d'acc√®s
            if (currentUser.type === 'cgp') {
                const conseillerSelect = document.getElementById('conseiller');
                conseillerSelect.value = currentUser.id;
                conseillerSelect.disabled = true;
                
                if (!currentUser.backOfficeAutorise) {
                    const suiviSection = document.getElementById('suiviBackOfficeSection');
                    suiviSection.querySelectorAll('input, select').forEach(field => {
                        field.classList.add('readonly');
                        field.disabled = true;
                    });
                }
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');

            if (tabName === 'operations') {
                displayOperations();
                updateStats();
            } else if (tabName === 'admin') {
                updateAdminStats();
            }
        }

        // ============= GESTION DES DONN√âES =============
        
        async function syncData() {
            if (!isOnline) {
                showSavePopup('‚ö†Ô∏è Hors ligne - Synchronisation impossible');
                return;
            }

            try {
                updateSaveIndicator('syncing');
                
                // Charger les donn√©es depuis le serveur
                const [operationsData, usersData] = await Promise.all([
                    fetchOperations(),
                    fetchUsers()
                ]);
                
                operations = operationsData;
                users = usersData;
                lastSyncTime = new Date();
                
                // Mettre √† jour l'interface
                populateSelects();
                displayOperations();
                updateStats();
                updateAdminStats();
                
                updateSaveIndicator('saved');
                updateLastSyncInfo();
                showSavePopup('‚úÖ Donn√©es synchronis√©es');
                
            } catch (error) {
                console.error('Erreur synchronisation:', error);
                updateSaveIndicator('offline');
                showSavePopup('‚ùå Erreur de synchronisation');
            }
        }

        function populateSelects() {
            if (!users.cgp) return;
            
            // CGP selects
            const cgpSelects = ['conseiller', 'filterCGP'];
            cgpSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = selectId === 'filterCGP' ? 
                    '<option value="">Tous</option>' : 
                    '<option value="">S√©lectionner...</option>';
                
                users.cgp.forEach(cgp => {
                    const option = document.createElement('option');
                    option.value = cgp.id;
                    option.textContent = cgp.nom;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            });

            // Back Office select
            const assistantSelect = document.getElementById('assistantBO');
            if (assistantSelect && users.backOffice) {
                assistantSelect.innerHTML = '<option value="">S√©lectionner...</option>';
                users.backOffice.forEach(bo => {
                    const option = document.createElement('option');
                    option.value = bo.id;
                    option.textContent = bo.nom;
                    assistantSelect.appendChild(option);
                });
            }
        }

        function updateContratsList() {
            const fournisseur = document.getElementById('fournisseur').value;
            const contratSelect = document.getElementById('nomContrat');
            
            contratSelect.innerHTML = '<option value="">S√©lectionner...</option>';
            
            const contrats = {
                'Cardif': ['Cardif Libert√©', 'Cardif Retraite Plus', 'Cardif Patrimoine'],
                'Generali': ['Generali Patrimoine', 'Generali Retraite', 'Generali Privil√®ge'],
                'AXA': ['AXA Placement', 'AXA Retraite Entreprise', 'AXA S√©lection']
            };
            
            if (fournisseur && contrats[fournisseur]) {
                contrats[fournisseur].forEach(contrat => {
                    const option = document.createElement('option');
                    option.value = contrat;
                    option.textContent = contrat;
                    contratSelect.appendChild(option);
                });
            }
        }

        function calculateCA() {
            const montant = parseFloat(document.getElementById('montant').value) || 0;
            const pourcentage = parseFloat(document.getElementById('pourcentageFrais').value) || 0;
            const incomprise = parseFloat(document.getElementById('partieIncomprise').value) || 0;
            
            const ca = (montant * pourcentage / 100) - incomprise;
            document.getElementById('caCalcule').value = Math.max(0, ca).toFixed(2);
        }

        // ============= GESTION DES OP√âRATIONS =============
        
        async function handleOperationSubmit(e) {
            e.preventDefault();
            
            if (!isOnline) {
                alert('‚ùå Impossible de sauvegarder hors ligne');
                return;
            }

            const form = e.target;
            const editingId = form.dataset.editingId;
            
            const operationData = {
                nomClient: document.getElementById('nomClient').value,
                nouveauClient: document.getElementById('nouveauClient').checked,
                conseiller: document.getElementById('conseiller').value,
                assistantBO: document.getElementById('assistantBO').value,
                domaine: document.getElementById('domaine').value,
                fournisseur: document.getElementById('fournisseur').value,
                nomContrat: document.getElementById('nomContrat').value,
                referenceContrat: document.getElementById('referenceContrat').value,
                typeActe: document.getElementById('typeActe').value,
                montant: parseFloat(document.getElementById('montant').value),
                pourcentageFrais: parseFloat(document.getElementById('pourcentageFrais').value) || 0,
                partieIncomprise: parseFloat(document.getElementById('partieIncomprise').value) || 0,
                ca: parseFloat(document.getElementById('caCalcule').value) || 0,
                apporteurAffaire: document.getElementById('apporteurAffaire').value,
                dateEnvoiCompagnie: document.getElementById('dateEnvoiCompagnie').value,
                dateRelance: document.getElementById('dateRelance').value,
                dateValidation: document.getElementById('dateValidation').value,
                etatGlobal: document.getElementById('etatGlobal').value,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };

            try {
                updateSaveIndicator('syncing');
                
                if (editingId) {
                    await updateOperation(editingId, operationData);
                    showSavePopup('‚úÖ Op√©ration mise √† jour');
                } else {
                    await createOperation(operationData);
                    showSavePopup('‚úÖ Op√©ration cr√©√©e');
                }
                
                form.reset();
                document.getElementById('caCalcule').value = '';
                delete form.dataset.editingId;
                
                if (currentUser.type === 'cgp') {
                    document.getElementById('conseiller').value = currentUser.id;
                }
                
                await syncData();
                switchTab('operations');
                
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                alert('‚ùå Erreur lors de la sauvegarde');
                updateSaveIndicator('offline');
            }
        }

        function displayOperations() {
            const tbody = document.getElementById('operationsTableBody');
            let filteredOperations = operations;

            // Filtrer selon l'utilisateur connect√©
            if (currentUser && currentUser.type === 'cgp') {
                filteredOperations = operations.filter(op => op.conseiller === currentUser.id);
            }

            // Appliquer les filtres
            filteredOperations = applyCurrentFilters(filteredOperations);

            tbody.innerHTML = '';
            filteredOperations.forEach(operation => {
                const row = createOperationRow(operation);
                tbody.appendChild(row);
            });
        }

        function createOperationRow(operation) {
            const row = document.createElement('tr');
            
            const statusClass = {
                'Envoy√© compagnie': 'status-envoye',
                'En cours': 'status-encours',
                'Valid√©': 'status-valide',
                'Annul√©': 'status-annule'
            }[operation.etatGlobal] || 'status-encours';

            const conseillerNom = users.cgp?.find(cgp => cgp.id === operation.conseiller)?.nom || operation.conseiller;

            row.innerHTML = `
                <td>${operation.nomClient} ${operation.nouveauClient ? '<span style="color: #28a745;">‚óè</span>' : ''}</td>
                <td>${conseillerNom}</td>
                <td>${operation.domaine}</td>
                <td>${operation.typeActe}</td>
                <td>${operation.montant?.toLocaleString('fr-FR')} ‚Ç¨</td>
                <td class="ca-highlight">${operation.ca?.toLocaleString('fr-FR')} ‚Ç¨</td>
                <td><span class="status-badge ${statusClass}">${operation.etatGlobal}</span></td>
                <td class="actions-cell">
                    <button onclick="editOperation(${operation.id})" class="btn btn-small">Modifier</button>
                    <button onclick="deleteOperationHandler(${operation.id})" class="btn btn-small btn-danger">Supprimer</button>
                </td>
            `;
            return row;
        }

        function applyCurrentFilters(operations) {
            const filterCGP = document.getElementById('filterCGP').value;
            const filterEtat = document.getElementById('filterEtat').value;
            const filterDomaine = document.getElementById('filterDomaine').value;

            return operations.filter(operation => {
                return (!filterCGP || operation.conseiller === filterCGP) &&
                       (!filterEtat || operation.etatGlobal === filterEtat) &&
                       (!filterDomaine || operation.domaine === filterDomaine);
            });
        }

        function applyFilters() {
            displayOperations();
            updateStats();
        }

        function updateStats() {
            let filteredOperations = operations;

            if (currentUser && currentUser.type === 'cgp') {
                filteredOperations = operations.filter(op => op.conseiller === currentUser.id);
            }

            filteredOperations = applyCurrentFilters(filteredOperations);

            const totalOperations = filteredOperations.length;
            const totalCA = filteredOperations.reduce((sum, op) => sum + (op.ca || 0), 0);
            const operationsEnCours = filteredOperations.filter(op => 
                op.etatGlobal === 'En cours' || op.etatGlobal === 'Envoy√© compagnie'
            ).length;

            document.getElementById('totalOperations').textContent = totalOperations;
            document.getElementById('totalCA').textContent = totalCA.toLocaleString('fr-FR') + '‚Ç¨';
            document.getElementById('operationsEnCours').textContent = operationsEnCours;
        }

        async function editOperation(id) {
            const operation = operations.find(op => op.id == id);
            if (!operation) return;

            // V√©rifier les droits
            if (currentUser.type === 'cgp' && operation.conseiller !== currentUser.id) {
                alert('Vous ne pouvez modifier que vos propres op√©rations.');
                return;
            }

            // Remplir le formulaire
            document.getElementById('nomClient').value = operation.nomClient || '';
            document.getElementById('nouveauClient').checked = operation.nouveauClient || false;
            document.getElementById('conseiller').value = operation.conseiller || '';
            document.getElementById('assistantBO').value = operation.assistantBO || '';
            document.getElementById('domaine').value = operation.domaine || '';
            document.getElementById('fournisseur').value = operation.fournisseur || '';
            
            updateContratsList();
            document.getElementById('nomContrat').value = operation.nomContrat || '';
            
            document.getElementById('referenceContrat').value = operation.referenceContrat || '';
            document.getElementById('typeActe').value = operation.typeActe || '';
            document.getElementById('montant').value = operation.montant || '';
            document.getElementById('pourcentageFrais').value = operation.pourcentageFrais || '';
            document.getElementById('partieIncomprise').value = operation.partieIncomprise || '';
            document.getElementById('apporteurAffaire').value = operation.apporteurAffaire || '';
            document.getElementById('dateEnvoiCompagnie').value = operation.dateEnvoiCompagnie || '';
            document.getElementById('dateRelance').value = operation.dateRelance || '';
            document.getElementById('dateValidation').value = operation.dateValidation || '';
            document.getElementById('etatGlobal').value = operation.etatGlobal || 'En cours';

            calculateCA();

            const form = document.getElementById('operationForm');
            form.dataset.editingId = id;
            form.querySelector('button[type="submit"]').textContent = 'Mettre √† jour op√©ration';

            switchTab('nouvelle');
        }

        async function deleteOperationHandler(id) {
            const operation = operations.find(op => op.id == id);
            if (!operation) return;

            if (currentUser.type === 'cgp' && operation.conseiller !== currentUser.id) {
                alert('Vous ne pouvez supprimer que vos propres op√©rations.');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette op√©ration ?')) {
                return;
            }

            try {
                updateSaveIndicator('syncing');
                await deleteOperation(id);
                await syncData();
                showSavePopup('‚úÖ Op√©ration supprim√©e');
            } catch (error) {
                console.error('Erreur suppression:', error);
                alert('‚ùå Erreur lors de la suppression');
                updateSaveIndicator('offline');
            }
        }

        // ============= GESTION DE L'√âTAT =============
        
        function updateConnectionStatus(online) {
            isOnline = online;
            const statusEl = document.getElementById('connectionStatus');
            
            if (online) {
                statusEl.className = 'connection-status online';
                statusEl.innerHTML = 'üü¢ Connect√© au serveur';
            } else {
                statusEl.className = 'connection-status offline';
                statusEl.innerHTML = 'üî¥ Hors ligne';
            }
        }

        function updateSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            
            switch (status) {
                case 'saved':
                    indicator.className = 'save-indicator saved';
                    indicator.innerHTML = '‚úÖ Donn√©es synchronis√©es';
                    break;
                case 'syncing':
                    indicator.className = 'save-indicator syncing';
                    indicator.innerHTML = 'üîÑ Synchronisation...';
                    break;
                case 'offline':
                    indicator.className = 'save-indicator offline';
                    indicator.innerHTML = '‚ùå Synchronisation √©chou√©e';
                    break;
            }
        }

        function updateLastSyncInfo() {
            if (lastSyncTime) {
                const info = document.getElementById('lastSyncInfo');
                info.textContent = 'Derni√®re sync : ' + lastSyncTime.toLocaleTimeString('fr-FR');
            }
        }

        function checkConnectionStatus() {
            fetch(API_BASE_URL + '/api/health')
                .then(() => updateConnectionStatus(true))
                .catch(() => updateConnectionStatus(false));
        }

        function startSyncInterval() {
            // Synchroniser toutes les 30 secondes
            syncInterval = setInterval(() => {
                if (isOnline && currentUser) {
                    syncData();
                }
            }, 30000);
        }

        function stopSyncInterval() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        function updateAdminStats() {
            if (currentUser && currentUser.type === 'admin') {
                document.getElementById('totalUsers').textContent = 
                    (users.cgp?.length || 0) + (users.backOffice?.length || 0);
                document.getElementById('totalOpsAdmin').textContent = operations.length;
                document.getElementById('lastActivityAdmin').textContent = 
                    lastSyncTime ? lastSyncTime.toLocaleTimeString('fr-FR') : '-';
                document.getElementById('appUrl').textContent = window.location.origin;
                document.getElementById('lastServerSync').textContent = 
                    lastSyncTime ? lastSyncTime.toLocaleString('fr-FR') : '-';
            }
        }

        function showSavePopup(message) {
            const existingPopup = document.querySelector('.save-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            const popup = document.createElement('div');
            popup.className = 'save-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 3000);
        }

        // Fonctions globales pour les boutons
        window.editOperation = editOperation;
        window.deleteOperationHandler = deleteOperationHandler;
    </script>
</body>
</html>
