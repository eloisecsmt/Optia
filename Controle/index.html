<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contr√¥le Documentaire - Cabinet de Gestion de Patrimoine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #1a1a2e;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(26, 26, 46, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffffff, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Debug Panel */
        .debug-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            display: none;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        /* File Upload Section */
        .file-upload-area {
            border: 3px dashed #d4af37;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: linear-gradient(135deg, #fefefe 0%, #f8f9fa 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #1a1a2e;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .file-upload-area.dragover {
            border-color: #1a1a2e;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .upload-icon {
            font-size: 4rem;
            color: #d4af37;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 1rem;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        /* File Info */
        .file-info {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .file-info.active {
            display: block;
        }

        .file-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #155724;
            margin-bottom: 10px;
        }

        .file-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .file-stat {
            background: rgba(255, 255, 255, 0.7);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #155724;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Filters */
        .filters-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a2e;
        }

        .filter-select, .filter-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.9rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .data-table th:first-child {
            border-radius: 10px 0 0 0;
        }

        .data-table th:last-child {
            border-radius: 0 10px 0 0;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.selected {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        /* Badges */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .badge.oui {
            background: #d4edda;
            color: #155724;
        }

        .badge.non {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.av {
            background: #cce5ff;
            color: #004085;
        }

        .badge.retraite {
            background: #e2e3e5;
            color: #383d41;
        }

        .badge.produits-structures {
            background: #fce4ec;
            color: #880e4f;
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(26, 26, 46, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #d4af37 100%);
            color: #1a1a2e;
        }

        .btn-debug {
            background: #17a2b8;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Selection Summary */
        .selection-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .selection-summary.active {
            display: block;
        }

        .selection-count {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        /* Checkbox */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #d4af37;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .checkbox.checked {
            background: #d4af37;
            color: white;
        }

        .checkbox.checked::after {
            content: '‚úì';
            font-weight: bold;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }

            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Contr√¥le Documentaire</h1>
            <p>Cabinet de Gestion de Patrimoine - Interface de gestion compl√®te</p>
        </div>

        <!-- Debug Panel -->
        <div class="debug-panel" id="debug-panel">
            <div class="debug-title">üîç Informations de d√©bogage</div>
            <div id="debug-content"></div>
        </div>

        <!-- Section 1: File Upload -->
        <div class="content-section active" id="file-upload-section">
            <h2 class="section-title">√âtape 1 : Ouverture du fichier Excel</h2>
            
            <div class="file-upload-area" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Cliquez pour s√©lectionner le fichier Excel</div>
                <div class="upload-subtext">ou glissez-d√©posez le fichier ici<br>Formats accept√©s: .xlsx, .xls, .xlsm</div>
            </div>
            
            <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls,.xlsm">
            
            <div class="file-info" id="file-info">
                <div class="file-name" id="file-name"></div>
                <div class="file-stats">
                    <div class="file-stat">
                        <div class="stat-number" id="total-rows">0</div>
                        <div class="stat-label">Dossiers trouv√©s</div>
                    </div>
                    <div class="file-stat">
                        <div class="stat-number" id="total-columns">0</div>
                        <div class="stat-label">Colonnes</div>
                    </div>
                    <div class="file-stat">
                        <div class="stat-number" id="file-size">0 KB</div>
                        <div class="stat-label">Taille du fichier</div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="proceedToSelection()">
                        Continuer vers la s√©lection
                    </button>
                    <button class="btn btn-secondary" onclick="resetFile()">
                        Changer de fichier
                    </button>
                    <button class="btn btn-debug btn-sm" onclick="toggleDebug()">
                        Afficher/Masquer Debug
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 2: Dossier Selection -->
        <div class="content-section" id="dossier-selection-section">
            <h2 class="section-title">√âtape 2 : S√©lection des dossiers √† contr√¥ler</h2>
            
            <!-- Filters -->
            <div class="filters-section">
                <h3 style="margin-bottom: 15px; color: #1a1a2e;">Filtres</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Conseiller</label>
                        <select class="filter-select" id="filter-conseiller">
                            <option value="">Tous les conseillers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Domaine</label>
                        <select class="filter-select" id="filter-domaine">
                            <option value="">Tous les domaines</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Nouveau Client</label>
                        <select class="filter-select" id="filter-nouveau">
                            <option value="">Tous</option>
                            <option value="Oui">Nouveaux clients uniquement</option>
                            <option value="Non">Clients existants uniquement</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Recherche</label>
                        <input type="text" class="filter-input" id="filter-search" placeholder="Nom, pr√©nom, r√©f√©rence...">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="applyFilters()">Appliquer les filtres</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">Effacer</button>
                    <button class="btn btn-warning" onclick="showFileUpload()">Changer de fichier</button>
                </div>
            </div>

            <!-- Selection Summary -->
            <div class="selection-summary" id="selection-summary">
                <div class="selection-count">
                    <span id="selected-count">0</span> dossier(s) s√©lectionn√©(s)
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="proceedToControl()">
                        D√©marrer le contr√¥le
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        D√©s√©lectionner tout
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>
                                <div class="checkbox-container">
                                    <div class="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()"></div>
                                </div>
                            </th>
                            <th>Client</th>
                            <th>Code Dossier</th>
                            <th>Assistant BO</th>
                            <th>Conseiller</th>
                            <th>Domaine</th>
                            <th>Contrat</th>
                            <th>Type Acte</th>
                            <th>Montant</th>
                            <th>√âtat BO</th>
                            <th>Nouveau</th>
                            <th>PPE</th>
                        </tr>
                    </thead>
                    <tbody id="dossiers-table-body">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section 3: Control Interface -->
        <div class="content-section" id="control-section">
            <h2 class="section-title">√âtape 3 : Contr√¥le documentaire</h2>
            <p>Interface de contr√¥le en cours de d√©veloppement...</p>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="showDossierSelection()">
                    Retour √† la s√©lection
                </button>
                <button class="btn btn-success" onclick="downloadResults()">
                    T√©l√©charger les r√©sultats
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let excelData = null;
        let allDossiers = [];
        let filteredDossiers = [];
        let selectedDossiers = [];
        let currentFile = null;
        let columnMapping = {}; // Mapping dynamique bas√© sur les headers

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
        });

        function setupFileUpload() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.querySelector('.file-upload-area');

            // File input change
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files: files } });
                }
            });

            // Setup real-time search
            const searchInput = document.getElementById('filter-search');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    if (this.value.length > 2 || this.value.length === 0) {
                        applyFilters();
                    }
                });
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            
            if (!file) return;

            // Validate file type
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                'application/vnd.ms-excel',                                          // .xls
                'application/vnd.ms-excel.sheet.macroEnabled.12'                     // .xlsm
            ];
            
            if (!validTypes.includes(file.type)) {
                alert('Veuillez s√©lectionner un fichier Excel (.xlsx, .xls ou .xlsm)');
                return;
            }

            currentFile = file;
            loadExcelFile(file);
        }

        function loadExcelFile(file) {
            const reader = new FileReader();
            
            // Show loading
            const uploadArea = document.querySelector('.file-upload-area');
            uploadArea.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Lecture du fichier Excel en cours...</div>
                </div>
            `;

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    debugLog('Feuilles trouv√©es: ' + workbook.SheetNames.join(', '));
                    
                    // Try different possible sheet names
                    let worksheet = null;
                    const possibleNames = ['R√©sultats Fusion', 'Resultats Fusion', 'r√©sultats fusion', 'Fusion', 'Sheet1', 'Feuil1'];
                    
                    for (let name of possibleNames) {
                        if (workbook.Sheets[name]) {
                            worksheet = workbook.Sheets[name];
                            debugLog('Feuille utilis√©e: ' + name);
                            break;
                        }
                    }
                    
                    if (!worksheet) {
                        // Use the first available sheet as fallback
                        const firstSheetName = workbook.SheetNames[0];
                        if (firstSheetName) {
                            worksheet = workbook.Sheets[firstSheetName];
                            debugLog('Utilisation de la premi√®re feuille: ' + firstSheetName);
                        } else {
                            throw new Error('Aucune feuille trouv√©e dans le fichier Excel');
                        }
                    }
                    
                    debugLog('Range de la feuille: ' + worksheet['!ref']);
                    
                    // Get ALL data
                    const allData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '',
                        raw: false // Keep formatted strings for dates/numbers
                    });
                    
                    debugLog('Nombre total de lignes: ' + allData.length);
                    
                    if (allData.length < 2) {
                        throw new Error('Le fichier doit contenir au moins une ligne d\'en-t√™tes et une ligne de donn√©es');
                    }

                    // Get headers from row 1 (index 0)
                    const headers = allData[0] || [];
                    debugLog('Headers trouv√©s (' + headers.length + '): ' + headers.slice(0, 10).join(', ') + '...');
                    
                    // Get data starting from row 2 (index 1)
                    const jsonData = allData.slice(1);
                    debugLog('Lignes de donn√©es: ' + jsonData.length);

                    if (jsonData.length === 0) {
                        throw new Error('Aucune donn√©e trouv√©e apr√®s la ligne d\'en-t√™tes');
                    }

                    processExcelData(jsonData, headers, file);
                    
                } catch (error) {
                    console.error('Erreur lors de la lecture du fichier:', error);
                    alert('Erreur lors de la lecture du fichier Excel: ' + error.message);
                    resetFileUpload();
                }
            };

            reader.onerror = function() {
                alert('Erreur lors de la lecture du fichier');
                resetFileUpload();
            };

            reader.readAsArrayBuffer(file);
        }

        function createColumnMapping(headers) {
            const mapping = {};
            
            debugLog('=== ANALYSE DES EN-T√äTES ===');
            headers.forEach((header, index) => {
                debugLog(`Colonne ${index}: "${header}" (Excel: ${getExcelColumnName(index)})`);
            });
            
            // MAPPING FORC√â pour les colonnes probl√©matiques (positions fixes)
            const forcedMapping = {
                'montant': 11, // Forcer la colonne L (index 11) pour le montant
                // Vous pouvez ajouter d'autres mappings forc√©s ici si n√©cessaire
                // 'client': 2, // Forcer colonne C si besoin
            };
            
            // Appliquer les mappings forc√©s d'abord
            debugLog('=== MAPPINGS FORC√âS ===');
            Object.entries(forcedMapping).forEach(([key, index]) => {
                if (index < headers.length && headers[index]) {
                    mapping[key] = index;
                    debugLog(`üîí Forc√©: ${key} -> colonne ${index} (${headers[index]}) (Excel: ${getExcelColumnName(index)})`);
                }
            });
            
            // Mapping bas√© sur les noms de colonnes avec priorit√© (premier trouv√© = celui utilis√©)
            const mappingRules = {
                'client': ['client', 'nom pr√©nom', 'nom prenom', 'nom client', 'pr√©nom nom', 'prenom nom'],
                'assistantBO': ['assistant bo', 'assistant back office', 'back office', 'assistant'],
                'conseiller': ['conseiller', 'nom conseiller', 'conseiller client', 'commercial', 'gestionnaire'],
                'nouveauClient': ['nouveau client', 'nvx client', 'nouveau', 'statut client'],
                'domaine': ['domaine', 'secteur', 'activit√©', 'activite', 'branche'],
                'fournisseur': ['fournisseur', 'partenaire', 'soci√©t√©', 'societe', 'compagnie'],
                'contrat': ['contrat', 'produit', 'support', 'v√©hicule', 'vehicule'],
                'reference': ['r√©f√©rence', 'reference', 'ref', 'n¬∞ r√©f√©rence', 'numero reference'],
                'typeActe': ['type acte', 'type d\'acte', 'acte', 'op√©ration', 'operation'],
                'montant': ['montant', 'capital', 'montant investi', 'valeur', 'somme', 'montant ‚Ç¨', 'capital ‚Ç¨'],
                'etatBO': ['√©tat bo', 'etat bo', 'statut bo', '√©tat', 'etat', 'statut'],
                'codeDossier': ['code dossier', 'n¬∞ dossier', 'numero dossier', 'id dossier', 'dossier'],
                'ppe': ['ppe', 'personne politiquement expos√©e', 'politiquement expos√©'],
                'dateEnvoi': ['date envoi', 'envoi', 'date transmission', 'exp√©dition'],
                'dateValidation': ['date validation', 'validation', 'valid√©', 'approuv√©']
            };

            // Pour chaque type de donn√©es, trouver la PREMI√àRE colonne qui correspond (sauf si d√©j√† forc√©)
            for (const [key, patterns] of Object.entries(mappingRules)) {
                // Skip si d√©j√† mapp√© par le mapping forc√©
                if (mapping[key] !== undefined) {
                    debugLog(`‚è≠Ô∏è  ${key} d√©j√† mapp√©, ignor√©`);
                    continue;
                }
                
                for (let index = 0; index < headers.length; index++) {
                    const header = headers[index];
                    if (!header || header.trim() === '') continue;
                    
                    // V√©rifier que cette colonne n'est pas d√©j√† utilis√©e
                    if (Object.values(mapping).includes(index)) continue;
                    
                    const headerLower = header.toLowerCase().trim()
                        .replace(/[√†√°√¢√£√§√•]/g, 'a')
                        .replace(/[√®√©√™√´]/g, 'e')
                        .replace(/[√¨√≠√Æ√Ø]/g, 'i')
                        .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
                        .replace(/[√π√∫√ª√º]/g, 'u')
                        .replace(/[√ß]/g, 'c')
                        .replace(/[√±]/g, 'n');
                    
                    // Chercher une correspondance exacte d'abord
                    for (const pattern of patterns) {
                        const patternClean = pattern.toLowerCase()
                            .replace(/[√†√°√¢√£√§√•]/g, 'a')
                            .replace(/[√®√©√™√´]/g, 'e')
                            .replace(/[√¨√≠√Æ√Ø]/g, 'i')
                            .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
                            .replace(/[√π√∫√ª√º]/g, 'u')
                            .replace(/[√ß]/g, 'c')
                            .replace(/[√±]/g, 'n');
                            
                        // Correspondance exacte prioritaire
                        if (headerLower === patternClean) {
                            mapping[key] = index;
                            debugLog(`‚úÖ Mapping exact: ${key} -> colonne ${index} (${header}) (Excel: ${getExcelColumnName(index)})`);
                            break;
                        }
                    }
                    
                    if (mapping[key] !== undefined) break;
                }
                
                // Si pas de correspondance exacte, chercher des correspondances partielles
                if (mapping[key] === undefined) {
                    for (let index = 0; index < headers.length; index++) {
                        const header = headers[index];
                        if (!header || header.trim() === '') continue;
                        
                        // V√©rifier que cette colonne n'est pas d√©j√† utilis√©e
                        if (Object.values(mapping).includes(index)) continue;
                        
                        const headerLower = header.toLowerCase().trim()
                            .replace(/[√†√°√¢√£√§√•]/g, 'a')
                            .replace(/[√®√©√™√´]/g, 'e')
                            .replace(/[√¨√≠√Æ√Ø]/g, 'i')
                            .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
                            .replace(/[√π√∫√ª√º]/g, 'u')
                            .replace(/[√ß]/g, 'c')
                            .replace(/[√±]/g, 'n');
                        
                        for (const pattern of patterns) {
                            const patternClean = pattern.toLowerCase()
                                .replace(/[√†√°√¢√£√§√•]/g, 'a')
                                .replace(/[√®√©√™√´]/g, 'e')
                                .replace(/[√¨√≠√Æ√Ø]/g, 'i')
                                .replace(/[√≤√≥√¥√µ√∂]/g, 'o')
                                .replace(/[√π√∫√ª√º]/g, 'u')
                                .replace(/[√ß]/g, 'c')
                                .replace(/[√±]/g, 'n');
                                
                            if (headerLower.includes(patternClean)) {
                                mapping[key] = index;
                                debugLog(`‚úÖ Mapping partiel: ${key} -> colonne ${index} (${header}) (Excel: ${getExcelColumnName(index)})`);
                                break;
                            }
                        }
                        
                        if (mapping[key] !== undefined) break;
                    }
                }
            }

            // Fallback intelligent SEULEMENT pour les colonnes essentielles non trouv√©es
            debugLog('=== FALLBACK POUR COLONNES CRITIQUES ===');
            
            // Le client est critique - fallback sur les premi√®res colonnes non utilis√©es
            if (!mapping.client) {
                for (let i = 1; i <= 5 && i < headers.length; i++) {
                    if (headers[i] && headers[i].trim() !== '' && !Object.values(mapping).includes(i)) {
                        mapping.client = i;
                        debugLog(`üîÑ Fallback client -> colonne ${i} (${headers[i]}) (Excel: ${getExcelColumnName(i)})`);
                        break;
                    }
                }
            }
            
            // Fallback pour assistant et conseiller seulement s'ils ne sont pas trouv√©s
            if (!mapping.assistantBO && mapping.client !== undefined) {
                for (let i = mapping.client + 1; i < headers.length && i <= mapping.client + 5; i++) {
                    if (headers[i] && headers[i].trim() !== '' && !Object.values(mapping).includes(i)) {
                        mapping.assistantBO = i;
                        debugLog(`üîÑ Fallback assistantBO -> colonne ${i} (${headers[i]}) (Excel: ${getExcelColumnName(i)})`);
                        break;
                    }
                }
            }
            
            if (!mapping.conseiller && mapping.client !== undefined) {
                for (let i = mapping.client + 1; i < headers.length && i <= mapping.client + 6; i++) {
                    if (headers[i] && headers[i].trim() !== '' && !Object.values(mapping).includes(i)) {
                        mapping.conseiller = i;
                        debugLog(`üîÑ Fallback conseiller -> colonne ${i} (${headers[i]}) (Excel: ${getExcelColumnName(i)})`);
                        break;
                    }
                }
            }

            debugLog('=== MAPPING FINAL ===');
            Object.entries(mapping).forEach(([key, index]) => {
                debugLog(`${key}: colonne ${index} -> "${headers[index]}" (Excel: ${getExcelColumnName(index)})`);
            });
            
            debugLog('=== COLONNES NON MAPP√âES ===');
            headers.forEach((header, index) => {
                if (header && header.trim() !== '' && !Object.values(mapping).includes(index)) {
                    debugLog(`‚ùå Colonne ${index} non utilis√©e: "${header}" (Excel: ${getExcelColumnName(index)})`);
                }
            });

            return mapping;
        }

        function getExcelColumnName(index) {
            // Convertit un index (0-based) en nom de colonne Excel (A, B, C, etc.)
            let result = '';
            let num = index;
            while (num >= 0) {
                result = String.fromCharCode(65 + (num % 26)) + result;
                num = Math.floor(num / 26) - 1;
                if (num < 0) break;
            }
            return result;
        }

        function processExcelData(jsonData, headers, file) {
            debugLog('=== D√âBUT TRAITEMENT DONN√âES ===');
            
            // Cr√©er le mapping dynamique
            columnMapping = createColumnMapping(headers);
            debugLog('Mapping final: ' + JSON.stringify(columnMapping));

            // Traiter les donn√©es
            allDossiers = jsonData
                .filter((row, index) => {
                    if (!row || row.length === 0) return false;
                    
                    // V√©rifier qu'il y a un nom de client
                    const clientIndex = columnMapping.client || 2;
                    const hasClient = row[clientIndex] && row[clientIndex].toString().trim() !== '';
                    
                    return hasClient;
                })
                .map((row, index) => {
                    const dossier = {
                        originalIndex: index,
                        
                        // Utiliser le mapping pour extraire les donn√©es avec debug pour les montants
                        client: getColumnValue(row, 'client') || '',
                        assistantBO: getColumnValue(row, 'assistantBO') || '',
                        conseiller: getColumnValue(row, 'conseiller') || '',
                        nouveauClient: getColumnValue(row, 'nouveauClient') || '',
                        domaine: getColumnValue(row, 'domaine') || '',
                        fournisseur: getColumnValue(row, 'fournisseur') || '',
                        contrat: getColumnValue(row, 'contrat') || '',
                        reference: getColumnValue(row, 'reference') || '',
                        typeActe: getColumnValue(row, 'typeActe') || '',
                        montant: (() => {
                            const rawMontant = getColumnValue(row, 'montant');
                            if (index < 3) { // Debug seulement pour les 3 premiers dossiers
                                debugLog(`=== DEBUG MONTANT DOSSIER ${index + 1} ===`);
                                debugLog(`Client: ${getColumnValue(row, 'client')}`);
                                debugLog(`Colonne montant (index ${columnMapping.montant}, Excel ${getExcelColumnName(columnMapping.montant)})`);
                                debugLog(`Valeur brute: "${rawMontant}" (type: ${typeof rawMontant})`);
                                debugLog(`Longueur: ${rawMontant ? rawMontant.length : 'N/A'}`);
                                debugLog(`Caract√®res: ${rawMontant ? Array.from(rawMontant).map(c => `'${c}' (${c.charCodeAt(0)})`).join(', ') : 'N/A'}`);
                                
                                // V√©rifier toute la ligne autour de la colonne montant
                                for (let i = Math.max(0, columnMapping.montant - 2); i <= Math.min(row.length - 1, columnMapping.montant + 2); i++) {
                                    debugLog(`Colonne ${i} (${getExcelColumnName(i)}): "${row[i]}" (type: ${typeof row[i]})`);
                                }
                            }
                            const formatted = formatMontant(rawMontant);
                            if (index < 3) {
                                debugLog(`R√©sultat format√©: "${formatted}"`);
                                debugLog(`=== FIN DEBUG MONTANT ===`);
                            }
                            return formatted;
                        })(),
                        etatBO: getColumnValue(row, 'etatBO') || '',
                        codeDossier: getColumnValue(row, 'codeDossier') || '',
                        ppe: getColumnValue(row, 'ppe') || '',
                        dateEnvoi: formatDate(getColumnValue(row, 'dateEnvoi')) || '',
                        dateValidation: formatDate(getColumnValue(row, 'dateValidation')) || '',
                        
                        rawData: row
                    };
                    
                    return dossier;
                });

            filteredDossiers = [...allDossiers];
            
            debugLog(`=== R√âSULTAT: ${allDossiers.length} dossiers trait√©s ===`);
            if (allDossiers.length > 0) {
                debugLog('Exemple de dossier trait√©: ' + JSON.stringify(allDossiers[0], null, 2));
            }
            
            // Update file info
            updateFileInfo(file, allDossiers.length, headers.length);
            
            // Populate filter options
            populateFilters();
        }

        function getColumnValue(row, columnKey) {
            const columnIndex = columnMapping[columnKey];
            if (columnIndex === undefined) {
                if (columnKey === 'montant') {
                    debugLog(`‚ùå ERREUR: Colonne '${columnKey}' non trouv√©e dans le mapping!`);
                    debugLog(`Mapping disponible: ${JSON.stringify(columnMapping)}`);
                    
                    // Tentative de recherche manuelle dans la colonne L (index 11)
                    if (row.length > 11 && row[11] !== undefined && row[11] !== '') {
                        debugLog(`üîç Tentative colonne L (index 11): "${row[11]}"`);
                        return row[11];
                    }
                }
                return '';
            }
            if (columnIndex >= row.length) {
                debugLog(`‚ùå Index ${columnIndex} hors limite pour la ligne (longueur: ${row.length})`);
                return '';
            }
            const value = row[columnIndex];
            
            if (columnKey === 'montant') {
                debugLog(`‚úÖ Colonne montant trouv√©e - Index: ${columnIndex}, Valeur: "${value}" (type: ${typeof value})`);
            }
            
            return value ? value.toString().trim() : '';
        }

        function formatMontant(value) {
            if (!value || value === '' || value === null || value === undefined) return '';
            
            debugLog(`Formatage montant - valeur brute: "${value}" (type: ${typeof value})`);
            
            // Si c'est d√©j√† un nombre (cas Excel avec format mon√©taire)
            if (typeof value === 'number') {
                debugLog(`Montant num√©rique: ${value}`);
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(value);
            }
            
            // Si c'est une cha√Æne, nettoyer et parser
            if (typeof value === 'string') {
                let cleanValue = value.toString().trim();
                
                // Supprimer les symboles mon√©taires et espaces
                cleanValue = cleanValue
                    .replace(/‚Ç¨/g, '') // Supprimer ‚Ç¨
                    .replace(/EUR/gi, '') // Supprimer EUR
                    .replace(/\s/g, '') // Supprimer tous les espaces
                    .replace(/\u00A0/g, '') // Supprimer espaces ins√©cables
                    .replace(/\u202F/g, '') // Supprimer espaces fins
                    .replace(/[^\d,.-]/g, ''); // Garder seulement chiffres, virgules, points, tirets
                
                debugLog(`Montant nettoy√©: "${cleanValue}"`);
                
                // Si c'est vide apr√®s nettoyage
                if (cleanValue === '' || cleanValue === '-') return '';
                
                // G√©rer les formats fran√ßais (virgule d√©cimale)
                // Remplacer la derni√®re virgule par un point si c'est une d√©cimale
                if (cleanValue.includes(',')) {
                    const parts = cleanValue.split(',');
                    if (parts.length === 2 && parts[1].length <= 2) {
                        // C'est probablement une d√©cimale (ex: "1 234,56")
                        cleanValue = parts[0].replace(/\./g, '') + '.' + parts[1];
                    } else {
                        // Virgules comme s√©parateurs de milliers
                        cleanValue = cleanValue.replace(/,/g, '');
                    }
                }
                
                // Supprimer les points utilis√©s comme s√©parateurs de milliers
                // Garder seulement le dernier point s'il y a 1-2 chiffres apr√®s
                const pointIndex = cleanValue.lastIndexOf('.');
                if (pointIndex !== -1) {
                    const afterPoint = cleanValue.substring(pointIndex + 1);
                    if (afterPoint.length > 2) {
                        // Probablement des s√©parateurs de milliers
                        cleanValue = cleanValue.replace(/\./g, '');
                    }
                }
                
                debugLog(`Montant final avant parsing: "${cleanValue}"`);
                
                const num = parseFloat(cleanValue);
                if (!isNaN(num)) {
                    debugLog(`Montant pars√©: ${num}`);
                    return new Intl.NumberFormat('fr-FR', {
                        style: 'currency',
                        currency: 'EUR'
                    }).format(num);
                } else {
                    debugLog(`Impossible de parser le montant: "${cleanValue}"`);
                    return value.toString(); // Retourner la valeur originale si parsing impossible
                }
            }
            
            debugLog(`Type de montant non g√©r√©: ${typeof value}`);
            return value.toString();
        }

        function formatDate(value) {
            if (!value) return '';
            
            // Si c'est un nombre Excel (date)
            if (typeof value === 'number') {
                try {
                    const date = XLSX.SSF.parse_date_code(value);
                    return `${date.d.toString().padStart(2, '0')}/${date.m.toString().padStart(2, '0')}/${date.y}`;
                } catch (e) {
                    return value.toString();
                }
            }
            
            // Si c'est d√©j√† une cha√Æne de date
            if (typeof value === 'string') {
                // Essayer de parser et reformater
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('fr-FR');
                }
            }
            
            return value.toString();
        }

        function updateFileInfo(file, rowCount, columnCount) {
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('total-rows').textContent = rowCount.toLocaleString();
            document.getElementById('total-columns').textContent = columnCount;
            document.getElementById('file-size').textContent = (file.size / 1024).toFixed(0) + ' KB';
            
            document.getElementById('file-info').classList.add('active');
        }

        function populateFilters() {
            debugLog('=== INITIALISATION FILTRES ===');
            
            // Obtenir les valeurs uniques pour les filtres (en excluant les valeurs vides)
            const conseillers = [...new Set(
                allDossiers
                    .map(d => d.conseiller)
                    .filter(c => c && c.trim() !== '' && c.trim() !== '-')
            )].sort();
            
            const domaines = [...new Set(
                allDossiers
                    .map(d => d.domaine)
                    .filter(d => d && d.trim() !== '' && d.trim() !== '-')
            )].sort();
            
            debugLog(`Conseillers trouv√©s: ${conseillers.length} - ${conseillers.slice(0, 5).join(', ')}${conseillers.length > 5 ? '...' : ''}`);
            debugLog(`Domaines trouv√©s: ${domaines.length} - ${domaines.slice(0, 5).join(', ')}${domaines.length > 5 ? '...' : ''}`);
            
            // Remplir le filtre conseiller
            const conseillerSelect = document.getElementById('filter-conseiller');
            conseillerSelect.innerHTML = '<option value="">Tous les conseillers</option>';
            if (conseillers.length > 0) {
                conseillers.forEach(conseiller => {
                    const option = document.createElement('option');
                    option.value = conseiller;
                    option.textContent = conseiller;
                    conseillerSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Aucun conseiller trouv√©';
                option.disabled = true;
                conseillerSelect.appendChild(option);
            }
            
            // Remplir le filtre domaine
            const domaineSelect = document.getElementById('filter-domaine');
            domaineSelect.innerHTML = '<option value="">Tous les domaines</option>';
            if (domaines.length > 0) {
                domaines.forEach(domaine => {
                    const option = document.createElement('option');
                    option.value = domaine;
                    option.textContent = domaine;
                    domaineSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Aucun domaine trouv√©';
                option.disabled = true;
                domaineSelect.appendChild(option);
            }
        }

        function resetFileUpload() {
            document.querySelector('.file-upload-area').innerHTML = `
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Cliquez pour s√©lectionner le fichier Excel</div>
                <div class="upload-subtext">ou glissez-d√©posez le fichier ici<br>Formats accept√©s: .xlsx, .xls, .xlsm</div>
            `;
            document.getElementById('file-info').classList.remove('active');
            document.getElementById('file-input').value = '';
            allDossiers = [];
            filteredDossiers = [];
            selectedDossiers = [];
            currentFile = null;
            columnMapping = {};
        }

        function resetFile() {
            resetFileUpload();
        }

        function proceedToSelection() {
            if (allDossiers.length === 0) {
                alert('Aucun dossier trouv√© dans le fichier');
                return;
            }
            
            debugLog('=== NAVIGATION VERS S√âLECTION ===');
            debugLog(`${allDossiers.length} dossiers disponibles`);
            
            showSection('dossier-selection-section');
            loadDossiersTable();
        }

        function showFileUpload() {
            showSection('file-upload-section');
        }

        function showDossierSelection() {
            showSection('dossier-selection-section');
        }

        function showSection(sectionId) {
            // Masquer toutes les sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section cible
            document.getElementById(sectionId).classList.add('active');
        }

        function loadDossiersTable() {
            debugLog('=== CHARGEMENT TABLEAU ===');
            debugLog(`Dossiers filtr√©s: ${filteredDossiers.length}`);
            
            const tbody = document.getElementById('dossiers-table-body');
            tbody.innerHTML = '';

            if (filteredDossiers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" style="text-align: center; padding: 40px; color: #6c757d;">
                            Aucun dossier trouv√© avec les filtres actuels
                        </td>
                    </tr>
                `;
                return;
            }

            filteredDossiers.forEach((dossier, index) => {
                const row = document.createElement('tr');
                const isSelected = selectedDossiers.includes(dossier.originalIndex);
                
                if (isSelected) {
                    row.classList.add('selected');
                }
                
                // Fonction pour afficher une valeur ou un placeholder
                const displayValue = (value, placeholder = '-') => {
                    return value && value.trim() !== '' ? value : `<span style="color: #999; font-style: italic;">${placeholder}</span>`;
                };
                
                row.innerHTML = `
                    <td>
                        <div class="checkbox-container">
                            <div class="checkbox ${isSelected ? 'checked' : ''}" 
                                 onclick="toggleDossierSelection(${dossier.originalIndex})"></div>
                        </div>
                    </td>
                    <td>
                        <strong>${dossier.client || 'Client non sp√©cifi√©'}</strong>
                        ${dossier.reference ? `<br><small>R√©f: ${dossier.reference}</small>` : ''}
                    </td>
                    <td>${displayValue(dossier.codeDossier, 'N/A')}</td>
                    <td>${displayValue(dossier.assistantBO, 'Non assign√©')}</td>
                    <td>${displayValue(dossier.conseiller, 'Non assign√©')}</td>
                    <td>${dossier.domaine ? `<span class="badge ${getBadgeClass(dossier.domaine)}">${dossier.domaine}</span>` : displayValue('', 'Non d√©fini')}</td>
                    <td>
                        ${displayValue(dossier.contrat, 'Non sp√©cifi√©')}
                        ${dossier.fournisseur ? `<br><small>${dossier.fournisseur}</small>` : ''}
                    </td>
                    <td>${displayValue(dossier.typeActe, 'Non d√©fini')}</td>
                    <td>${dossier.montant ? `<strong>${dossier.montant}</strong>` : displayValue('', 'N/A')}</td>
                    <td>${displayValue(dossier.etatBO, 'Non d√©fini')}</td>
                    <td>${dossier.nouveauClient ? `<span class="badge ${dossier.nouveauClient.toLowerCase()}">${dossier.nouveauClient}</span>` : displayValue('', 'N/A')}</td>
                    <td>${dossier.ppe && dossier.ppe.toLowerCase() === 'oui' ? '<span class="badge oui">PPE</span>' : displayValue('', 'Non')}</td>
                `;
                
                tbody.appendChild(row);
            });

            updateSelectAllCheckbox();
            debugLog(`Tableau charg√© avec ${filteredDossiers.length} lignes`);
        }

        function getBadgeClass(domaine) {
            if (!domaine) return '';
            const domain = domaine.toLowerCase();
            if (domain.includes('av')) return 'av';
            if (domain.includes('retraite')) return 'retraite';
            if (domain.includes('structure')) return 'produits-structures';
            return '';
        }

        function toggleDossierSelection(originalIndex) {
            const checkbox = event.target;
            const row = checkbox.closest('tr');
            
            if (selectedDossiers.includes(originalIndex)) {
                selectedDossiers = selectedDossiers.filter(id => id !== originalIndex);
                checkbox.classList.remove('checked');
                row.classList.remove('selected');
            } else {
                selectedDossiers.push(originalIndex);
                checkbox.classList.add('checked');
                row.classList.add('selected');
            }
            
            updateSelectionSummary();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const allCheckbox = document.getElementById('select-all-checkbox');
            const visibleIndices = filteredDossiers.map(d => d.originalIndex);
            const allVisibleSelected = visibleIndices.every(index => selectedDossiers.includes(index));
            
            if (allVisibleSelected) {
                // D√©s√©lectionner tous les visibles
                selectedDossiers = selectedDossiers.filter(id => !visibleIndices.includes(id));
                allCheckbox.classList.remove('checked');
            } else {
                // S√©lectionner tous les visibles
                visibleIndices.forEach(index => {
                    if (!selectedDossiers.includes(index)) {
                        selectedDossiers.push(index);
                    }
                });
                allCheckbox.classList.add('checked');
            }
            
            loadDossiersTable(); // Rafra√Æchir pour mettre √† jour les checkboxes
            updateSelectionSummary();
        }

        function updateSelectAllCheckbox() {
            const allCheckbox = document.getElementById('select-all-checkbox');
            const visibleIndices = filteredDossiers.map(d => d.originalIndex);
            const allVisibleSelected = visibleIndices.length > 0 && visibleIndices.every(index => selectedDossiers.includes(index));
            
            if (allVisibleSelected) {
                allCheckbox.classList.add('checked');
            } else {
                allCheckbox.classList.remove('checked');
            }
        }

        function updateSelectionSummary() {
            const summary = document.getElementById('selection-summary');
            const countSpan = document.getElementById('selected-count');
            
            countSpan.textContent = selectedDossiers.length;
            
            if (selectedDossiers.length > 0) {
                summary.classList.add('active');
            } else {
                summary.classList.remove('active');
            }
        }

        function clearSelection() {
            selectedDossiers = [];
            loadDossiersTable();
            updateSelectionSummary();
        }

        function applyFilters() {
            debugLog('=== APPLICATION FILTRES ===');
            
            const conseiller = document.getElementById('filter-conseiller').value;
            const domaine = document.getElementById('filter-domaine').value;
            const nouveau = document.getElementById('filter-nouveau').value;
            const search = document.getElementById('filter-search').value.toLowerCase().trim();

            filteredDossiers = allDossiers.filter(dossier => {
                const matchConseiller = !conseiller || (dossier.conseiller && dossier.conseiller === conseiller);
                const matchDomaine = !domaine || (dossier.domaine && dossier.domaine === domaine);
                const matchNouveau = !nouveau || (dossier.nouveauClient && dossier.nouveauClient === nouveau);
                const matchSearch = !search || 
                    (dossier.client && dossier.client.toLowerCase().includes(search)) || 
                    (dossier.codeDossier && dossier.codeDossier.toLowerCase().includes(search)) ||
                    (dossier.contrat && dossier.contrat.toLowerCase().includes(search)) ||
                    (dossier.reference && dossier.reference.toLowerCase().includes(search));

                return matchConseiller && matchDomaine && matchNouveau && matchSearch;
            });

            loadDossiersTable();
            debugLog(`Filtres appliqu√©s: ${filteredDossiers.length} dossiers sur ${allDossiers.length}`);
        }

        function clearFilters() {
            document.getElementById('filter-conseiller').value = '';
            document.getElementById('filter-domaine').value = '';
            document.getElementById('filter-nouveau').value = '';
            document.getElementById('filter-search').value = '';
            
            filteredDossiers = [...allDossiers];
            loadDossiersTable();
        }

        function proceedToControl() {
            if (selectedDossiers.length === 0) {
                alert('Veuillez s√©lectionner au moins un dossier √† contr√¥ler.');
                return;
            }
            
            showSection('control-section');
            
            // Log des dossiers s√©lectionn√©s pour d√©veloppement
            const selectedDossierData = allDossiers.filter(d => selectedDossiers.includes(d.originalIndex));
            debugLog(`Dossiers s√©lectionn√©s pour contr√¥le: ${selectedDossierData.length}`);
        }

        function downloadResults() {
            if (selectedDossiers.length === 0) {
                alert('Aucun dossier s√©lectionn√© pour l\'export.');
                return;
            }

            // Obtenir les donn√©es des dossiers s√©lectionn√©s
            const selectedDossierData = allDossiers.filter(d => selectedDossiers.includes(d.originalIndex));
            
            // Cr√©er les donn√©es d'export avec r√©sultats de contr√¥le placeholder
            const exportData = selectedDossierData.map(dossier => ({
                'Client': dossier.client,
                'Code Dossier': dossier.codeDossier,
                'Assistant BO': dossier.assistantBO,
                'Conseiller': dossier.conseiller,
                'Nouveau Client': dossier.nouveauClient,
                'Domaine': dossier.domaine,
                'Fournisseur': dossier.fournisseur,
                'Contrat': dossier.contrat,
                'R√©f√©rence': dossier.reference,
                'Type Acte': dossier.typeActe,
                'Montant': dossier.montant,
                '√âtat BO': dossier.etatBO,
                'PPE': dossier.ppe,
                'Date Contr√¥le': new Date().toLocaleDateString('fr-FR'),
                'Contr√¥l√© par': 'Utilisateur',
                'Statut Contr√¥le': 'En cours...',
                'Remarques': 'Contr√¥le en cours de d√©veloppement'
            }));

            // Cr√©er le workbook
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Contr√¥les");

            // T√©l√©charger le fichier
            const fileName = `Controles_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert(`Fichier "${fileName}" t√©l√©charg√© avec ${selectedDossierData.length} dossier(s).`);
        }

        // Fonctions de debug
        function debugLog(message) {
            console.log(message);
            
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `<div>${timestamp}: ${message}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            const debugPanel = document.getElementById('debug-panel');
            debugPanel.classList.toggle('active');
        }
    </script>
</body>
</html>